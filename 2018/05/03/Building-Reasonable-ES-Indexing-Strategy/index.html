<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><title>构建合理的ES索引策略 - 侯锐的思考与分享</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="keywords" content="ElasticSearch,搜索引擎,架构"><meta name="description" content="&lt;h3 id=&#34;关于索引的大小&#34;&gt;&lt;a href=&#34;#关于索引的大小&#34; class=&#34;headerlink&#34; title=&#34;关于索引的大小&#34;&gt;&lt;/a&gt;关于索引的大小&lt;/h3&gt;&lt;p&gt;由于ES在后续的版本中已经不再支持type，所以建议每一个索引中只存放一个type类型的数据，避免在一个索引中创建多个type。&lt;/p&gt;
&lt;p&gt;对于拥有大量数据的索引，我们应该对其进行合理的拆分。由于SaaS服务的特殊性，在SaaS服务中每一个用户都是一个独立的个体，而一个用户的所有的数据都必然是属于该用户的。因此我们选择的策略是根据每个客户的编号来计算其hash值，之后我们在命名ES索引的时候会添加上此hash值。例如对于商品数据，我们可以将索引的名字设置为 &lt;code&gt;products-&amp;#123;hashcode&amp;#125;&lt;/code&gt;，这样的话根据用户编号计算出来的hash值不同将导致用户数据被存储到不同的索引上，如此一来就可以把本来需要保存在一个索引中的数据拆分到多个索引中。具体需要拆分为多少个索引可以根据不同的hash算法来决定，之后在查询数据的时候同样的根据用户编号计算一次hash值就可以得到"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="侯锐的思考与分享" type="application/atom+xml"></head><body><div class="container"><header class="header"><div class="blog-title"><a href="/" class="logo">侯锐的思考与分享</a><div class="subtitle"></div></div><nav class="navbar"><ul class="menu"><li class="menu-item"><a href="/" class="menu-item-link" data-no-instant>主页</a></li><li class="menu-item"><a href="/atom.xml" class="menu-item-link" data-no-instant>订阅</a></li><li class="menu-item"><a href="/search" class="menu-item-link" data-no-instant>搜索</a></li></ul></nav></header><article class="post"><div class="post-title"><h1 class="article-title">构建合理的ES索引策略</h1></div><div class="post-meta"><span class="post-time">2018-05-03</span></div><div class="post-content"><h3 id="关于索引的大小"><a href="#关于索引的大小" class="headerlink" title="关于索引的大小"></a>关于索引的大小</h3><p>由于ES在后续的版本中已经不再支持type，所以建议每一个索引中只存放一个type类型的数据，避免在一个索引中创建多个type。</p><p>对于拥有大量数据的索引，我们应该对其进行合理的拆分。由于SaaS服务的特殊性，在SaaS服务中每一个用户都是一个独立的个体，而一个用户的所有的数据都必然是属于该用户的。因此我们选择的策略是根据每个客户的编号来计算其hash值，之后我们在命名ES索引的时候会添加上此hash值。例如对于商品数据，我们可以将索引的名字设置为 <code>products-&#123;hashcode&#125;</code>，这样的话根据用户编号计算出来的hash值不同将导致用户数据被存储到不同的索引上，如此一来就可以把本来需要保存在一个索引中的数据拆分到多个索引中。具体需要拆分为多少个索引可以根据不同的hash算法来决定，之后在查询数据的时候同样的根据用户编号计算一次hash值就可以得到索引的真实名称，此时只需要去对应的索引中进行数据查找就可以了。</p><p>上面这种方式存在两种问题：</p><ol><li>一旦hash算法确定，之后就不能随意更改。假如我们已经把商品数据拆分到10个独立的索引中了，现在我们发现索引压力依旧较大想要增加索引的数量到20个，但是由于我们的hash算法已经固定所以不能直接添加，因为hash算法一旦改变将导致之前已经存储的数据查询出错，此时只能手动的把数据同步到新的索引中了，相当的麻烦；</li><li>逻辑上存在关系的数据不应该被拆分到多个索引中，由于我们能够保证一个用户的数据必然被保存在一个指定的索引上，而我们在查询数据的时候必然是根据用户的数据进行查询的，这就使得我们在查询的时候绝对不会出现跨索引查询的情况。如果由于业务上的特点导致无法将数据从逻辑上拆分到多个索引中，这必然会使得在进行数据查询的时候要跨索引，而跨索引的数据查询将必然导致查询操作的复杂化，这是应该被避免的；</li></ol><h3 id="索引模板"><a href="#索引模板" class="headerlink" title="索引模板"></a>索引模板</h3><p>建议在组建ES集群的时候设置一些合理的索引模板（<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html">Index Templates</a>），它的好处在于之后每次创建一个新的索引的时候，都能够给这个索引自动的添加上一些合适的 <code>settings</code> 和 <code>mappings</code> 而不需要手动的去设置这些属性。而且由于索引模板支持通配符，所以我们可以更加细致的针对不同类型的索引来设置不同的配置。</p><p>除了Index Templates这个全局的配置，我们在创建索引的时候也可以手动的设置一个索引的mapping，需要注意的是mapping本身包含了 <code>properties</code> 和 <code>dynamic template</code> 这两种配置，前一种是手动的为每一个field设置其mapping，而后一个则是根据ES自动推断出来的此field的类型和field的名称来设置这个field的mapping，所以我们知道了一个field的mapping有三种设置方式：</p><ol><li>根据mapping中properties来手动设定；</li><li>ES自动的根据field的值来进行动态类型推断而确定一个field的mapping；</li><li>dynamic template可以根据字段被自动推断出来的类型和字段名称来决定一个字段的mapping；</li></ol><p>顺便说一下一旦一个字段的mapping被确定了之后就不能被更改了，这也是很容易产生bug的地方。除此之外，我们还应该避免使用动态变化的值作为字段的名称，否则将很容易导致<a target="_blank" rel="noopener" href="https://www.elastic.co/blog/found-crash-elasticsearch#mapping-explosion">Mapping Explosion</a>。</p><h3 id="构建ES集群的策略"><a href="#构建ES集群的策略" class="headerlink" title="构建ES集群的策略"></a>构建ES集群的策略</h3><p>把重要且读写量较大的业务数据放到性能更为强劲的ES集群中，将其余的业务数据放到普通的ES集群中，通过这样的策略可以降低ES集群的压力并且提高系统的稳定性。</p></div><div class="post-copyright"><div><strong>本文链接：</strong> <span title="构建合理的ES索引策略">https://www.nosuchfield.com/2018/05/03/Building-Reasonable-ES-Indexing-Strategy/</span></div><div><strong>版权声明： </strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处！</div></div><style>summary{cursor:pointer;margin-bottom:10px}summary:focus{outline:0}</style><script src="/js/code-enhancer.js"></script><script src="/js/pangu.min.js"></script><script>pangu.spacingPage()</script><script>function backToTop(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script defer src="https://cloud.umami.is/script.js" data-website-id="267e4aaf-8cb5-464d-b16c-89e66283e505"></script><div class="post-footer"><ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/ElasticSearch/" rel="tag">ElasticSearch</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/" rel="tag">搜索引擎</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E6%9E%B6%E6%9E%84/" rel="tag">架构</a></li></ul><span onclick="backToTop()" class="top">返回顶部</span></div></article><footer><span>&copy; 2015 - 2025</span> <span class="author">Raymond</span> <span style="float:right"><span class="upyun">本网站由<a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"> <img src="/images/others/upyun.png"></a>提供CDN加速&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <a class="filing" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备15057335号</a> <a class="github" href="https://github.com/RitterHou" target="_blank">GitHub</a></span></footer></div></body></html>