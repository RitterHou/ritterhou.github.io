<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><title>使用APISIX解析jwt并获取payload信息 - 侯锐的思考与分享</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="keywords" content="APISIX,JWT,微服务,API网关,Lua,认证授权"><meta name="description" content="&lt;p&gt;APISIX支持获取jwt的信息，并且将这个信息进行解码并转发给后端服务。&lt;/p&gt;
&lt;h3 id=&#34;1-启动服务&#34;&gt;&lt;a href=&#34;#1-启动服务&#34; class=&#34;headerlink&#34; title=&#34;1. 启动服务&#34;&gt;&lt;/a&gt;1. 启动服务&lt;/h3&gt;&lt;p&gt;首先我们根据&lt;a href=&#34;https://docs.api7.ai/apisix/getting-started&#34;&gt;官方脚本&lt;/a&gt;来启动APISIX服务&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;~ curl -sL &amp;quot;https://run.api7.ai/apisix/quickstart&amp;quot; | sh
Destroying existing apisix-quickstart container, if any.

Installing APISIX with the quickstart options.

Creating bridge network apisix-quickstart-net.
77e35df073894075ad77facd9d1c7d2a35b280213732c1b631052"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="侯锐的思考与分享" type="application/atom+xml"></head><body><div class="container"><header class="header"><div class="blog-title"><a href="/" class="logo">侯锐的思考与分享</a><div class="subtitle"></div></div><nav class="navbar"><ul class="menu"><li class="menu-item"><a href="/" class="menu-item-link" data-no-instant>主页</a></li><li class="menu-item"><a href="/atom.xml" class="menu-item-link" data-no-instant>订阅</a></li><li class="menu-item"><a href="/search" class="menu-item-link" data-no-instant>搜索</a></li></ul></nav></header><article class="post"><div class="post-title"><h1 class="article-title">使用APISIX解析jwt并获取payload信息</h1></div><div class="post-meta"><span class="post-time">2025-07-11</span></div><div class="post-content"><p>APISIX支持获取jwt的信息，并且将这个信息进行解码并转发给后端服务。</p><h3 id="1-启动服务"><a href="#1-启动服务" class="headerlink" title="1. 启动服务"></a>1. 启动服务</h3><p>首先我们根据<a target="_blank" rel="noopener" href="https://docs.api7.ai/apisix/getting-started">官方脚本</a>来启动APISIX服务</p><pre><code>~ curl -sL &quot;https://run.api7.ai/apisix/quickstart&quot; | sh
Destroying existing apisix-quickstart container, if any.

Installing APISIX with the quickstart options.

Creating bridge network apisix-quickstart-net.
77e35df073894075ad77facd9d1c7d2a35b280213732c1b631052caede079bab
✔ network apisix-quickstart-net created

Starting the container etcd-quickstart.
d123605c8b7658b130be97e5f44e7a160aa85858db008032ecf594266225e342
✔ etcd is listening on etcd-quickstart:2379

Starting the container apisix-quickstart.
38434806c63b3a72f53fb6ad849cb4c11781eebaff79c8db04510226593fcf46
⚠ WARNING: The Admin API key is currently disabled. You should turn on admin_key_required and set a strong Admin API key in production for security.

✔ APISIX is ready!
</code></pre><h3 id="2-配置插件"><a href="#2-配置插件" class="headerlink" title="2. 配置插件"></a>2. 配置插件</h3><p>启动了APISIX之后，我们首先创建一个插件配置。在这个插件中我们定义了一个Lua方法，这个方法的目的是从请求的header中获取authorization信息，并进行解码，之后将解码的信息放到HTTP header中传给后端</p><pre><code>curl --location --request PUT &#39;http://127.0.0.1:9180/apisix/admin/plugin_configs/1001&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: */*&#39; \
--header &#39;Host: 127.0.0.1:9180&#39; \
--header &#39;Connection: keep-alive&#39; \
--data-raw &#39;&#123;
    &quot;plugins&quot;: &#123;
        &quot;serverless-pre-function&quot;: &#123;
            &quot;phase&quot;: &quot;access&quot;,
            &quot;functions&quot;: [
                &quot;return function(_, ctx) local core = require(\&quot;apisix.core\&quot;) local jwt = require(\&quot;resty.jwt\&quot;) local auth_header = ctx.var.http_authorization if not auth_header then return end local token = auth_header:match(\&quot;Bearer%s+(.+)\&quot;) if not token then return end local obj = jwt:load_jwt(token) if obj and obj.valid and obj.payload then if obj.payload.user_id then core.request.set_header(\&quot;X-User-Id\&quot;, obj.payload.user_id) end if obj.payload.role then core.request.set_header(\&quot;X-User-Role\&quot;, obj.payload.role) end end end&quot;
            ]
        &#125;
    &#125;
&#125;&#39;
</code></pre><p>如上的fucntions属性中添加了一个Lua方法，格式化之后的Lua代码如下</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(_, ctx)</span></span></span><br><span class="line">  <span class="keyword">local</span> core = <span class="built_in">require</span>(<span class="string">&quot;apisix.core&quot;</span>)</span><br><span class="line">  <span class="keyword">local</span> jwt = <span class="built_in">require</span>(<span class="string">&quot;resty.jwt&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> auth_header = ctx.var.http_authorization</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> auth_header <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> token = auth_header:<span class="built_in">match</span>(<span class="string">&quot;Bearer%s+(.+)&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> token <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> obj = jwt:load_jwt(token)</span><br><span class="line">  <span class="keyword">if</span> obj <span class="keyword">and</span> obj.valid <span class="keyword">and</span> obj.payload <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> obj.payload.user_id <span class="keyword">then</span></span><br><span class="line">      core.request.set_header(<span class="string">&quot;X-User-Id&quot;</span>, obj.payload.user_id)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> obj.payload.role <span class="keyword">then</span></span><br><span class="line">      core.request.set_header(<span class="string">&quot;X-User-Role&quot;</span>, obj.payload.role)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>这段代码实现了如下几个功能：</p><ol><li>从 Authorization: Bearer<token>中提取 JWT</token></li><li>使用 resty.jwt 解码</li><li>如果合法，提取 user_id 和 role</li><li>注入到 header（X-User-Id, X-User-Role）中供后端读取</li></ol><h3 id="3-配置consumer"><a href="#3-配置consumer" class="headerlink" title="3. 配置consumer"></a>3. 配置consumer</h3><p>创建了这个插件之后，我们再新建一个consumer。在APISIX中，consumer代表了一类客户端，比如APP。我们可以针对这类客户端添加一些配置，多种不同类型的客户端（比如APP、网页、开放平台，等等）可以分别设置成不同的consumer以方便管理</p><pre><code>curl --location --request PUT &#39;http://127.0.0.1:9180/apisix/admin/consumers/app&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: */*&#39; \
--header &#39;Host: 127.0.0.1:9180&#39; \
--header &#39;Connection: keep-alive&#39; \
--data-raw &#39;&#123;
    &quot;username&quot;: &quot;app&quot;,
    &quot;plugins&quot;: &#123;
        &quot;jwt-auth&quot;: &#123;
            &quot;key&quot;: &quot;app-key&quot;,
            &quot;secret&quot;: &quot;a-string-secret-at-least-256-bits-long&quot;,
            &quot;algorithm&quot;: &quot;HS256&quot;
        &#125;
    &#125;
&#125;&#39;
</code></pre><p>如上添加了一个名为app的consumer，它的key是<code>app-key</code>，加密方式是<code>HS256</code>，密钥是<code>a-string-secret-at-least-256-bits-long</code>。有了解析插件和consumer之后，我们就可以创建路由了。</p><h3 id="4-配置路由"><a href="#4-配置路由" class="headerlink" title="4. 配置路由"></a>4. 配置路由</h3><p>如下请求会创建一个ID为<code>1</code>的路由，使用了ID为<code>1001</code>插件，并且添加了<code>jwt-auth</code>的配置，路由的后端是<a target="_blank" rel="noopener" href="https://httpbin.org/">https://httpbin.org</a>，这个网站会把我们请求的信息返回给我们。</p><pre><code>curl --location --request PUT &#39;http://127.0.0.1:9180/apisix/admin/routes/1&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: */*&#39; \
--header &#39;Host: 127.0.0.1:9180&#39; \
--header &#39;Connection: keep-alive&#39; \
--data-raw &#39;&#123;
    &quot;uri&quot;: &quot;/headers&quot;,
    &quot;plugin_config_id&quot;: 1001,
    &quot;plugins&quot;: &#123;
        &quot;jwt-auth&quot;: &#123;&#125;
    &#125;,
    &quot;upstream&quot;: &#123;
        &quot;type&quot;: &quot;roundrobin&quot;,
        &quot;nodes&quot;: &#123;
            &quot;httpbin.org:80&quot;: 1
        &#125;
    &#125;
&#125;&#39;
</code></pre><h3 id="5-发起请求"><a href="#5-发起请求" class="headerlink" title="5. 发起请求"></a>5. 发起请求</h3><p>在创建好了plugin_config、consumer和route之后，我们就可以测试请求了。首先我们构建如下payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app-key&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="number">100001</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;exp&quot;</span><span class="punctuation">:</span> <span class="number">1900000000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这个payload包含了<code>user_id</code>和<code>role</code>两个业务属性，exp代表这个jwt的过期时间戳，key是APISIX用于识别匹配哪个consumer的，这里我们选择匹配<code>app-key</code>这个consumer。之后我们将该payload和密钥<code>a-string-secret-at-least-256-bits-long</code>一起在<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a>进行编码，得到编码jwt信息如下</p><pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJhcHAta2V5IiwidXNlcl9pZCI6MTAwMDAxLCJyb2xlIjoiYWRtaW4iLCJleHAiOjE5MDAwMDAwMDB9.qG7PNPz2XlatmjrhNW_xf6SmI8T9JSIx2lJVJcAox0I
</code></pre><p>之后我们执行HTTP请求，将这个jwt放到Authorization header中</p><pre><code>curl --location --request GET &#39;http://127.0.0.1:9080/headers&#39; \
--header &#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJhcHAta2V5IiwidXNlcl9pZCI6MTAwMDAxLCJyb2xlIjoiYWRtaW4iLCJleHAiOjE5MDAwMDAwMDB9.qG7PNPz2XlatmjrhNW_xf6SmI8T9JSIx2lJVJcAox0I&#39; \
--header &#39;Accept: */*&#39; \
--header &#39;Host: httpbin.org:80&#39; \
--header &#39;Connection: keep-alive&#39;
</code></pre><p>请求得到的响应如下，可以看到user_id和role属性已经成功的传给后端服务了</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Accept&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Authorization&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJhcHAta2V5IiwidXNlcl9pZCI6MTAwMDAxLCJyb2xlIjoiYWRtaW4iLCJleHAiOjE5MDAwMDAwMDB9.qG7PNPz2XlatmjrhNW_xf6SmI8T9JSIx2lJVJcAox0I&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;httpbin.org&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;User-Agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;curl/7.81.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Amzn-Trace-Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Root=1-68709903-309891501348175943af3223&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Consumer-Username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-Forwarded-Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;httpbin.org&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-User-Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;100001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-User-Role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div><div class="post-copyright"><div><strong>本文链接：</strong> <span title="使用APISIX解析jwt并获取payload信息">https://www.nosuchfield.com/2025/07/11/APISIX-parse-JWT-and-get-payload-information/</span></div><div><strong>版权声明： </strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处！</div></div><style>summary{cursor:pointer;margin-bottom:10px}summary:focus{outline:0}</style><script src="/js/code-enhancer.js"></script><script src="/js/pangu.min.js"></script><script>pangu.spacingPage()</script><script>function backToTop(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script defer src="https://cloud.umami.is/script.js" data-website-id="267e4aaf-8cb5-464d-b16c-89e66283e505"></script><div class="post-footer"><ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/APISIX/" rel="tag">APISIX</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/API%E7%BD%91%E5%85%B3/" rel="tag">API网关</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/Lua/" rel="tag">Lua</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/" rel="tag">认证授权</a></li></ul><span onclick="backToTop()" class="top">返回顶部</span></div></article><footer><span>&copy; 2015 - 2025</span> <span class="author">Raymond</span> <span style="float:right"><span class="upyun">本网站由<a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"> <img src="/images/others/upyun.png"></a>提供CDN加速&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <a class="filing" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备15057335号</a> <a class="github" href="https://github.com/RitterHou" target="_blank">GitHub</a></span></footer></div></body></html>