<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><title>Elasticsearch不同版本的压力测试与结果对比 - 侯锐的思考与分享</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="keywords" content="ElasticSearch,压力测试"><meta name="description" content="&lt;p&gt;公司目前所使用的Elasticsearch（以下简称ES）版本是在2015年的时候选择的，当时选择了ES的最新版本1.5.2。随着ES官方的快速发展，ES也已经推出了很多新的版本，这些新版本往往伴随着一些新特性的发布以及性能的提升，为了使用到这些新特性，我们决定将ES的版本升级到7.5.2。&lt;/p&gt;
&lt;p&gt;ES版本升级会遇到API不兼容的问题，我们的解决办法是在业务和ES之间增加一层_搜索平台_来做接口兼容。此外我们在版本升级之前还需要了解一下ES-7.5.2相对于ES-1.5.2有多少性能提升，所以我们需要针对这两个版本做一下性能测试并对结果进行对比。我们使用如下的四台负载来做性能测试&lt;/p&gt;

&lt;!-- 添加滚动条 --&gt;
&lt;div style=&#34;overflow: auto;&#34;&gt;
&lt;!-- 表格内的文字不折叠换行 --&gt;
&lt;style&gt;div table {white-space: nowrap;}&lt;/style&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;序号&lt;/th&gt;
&lt;th&gt;节点IP&lt;/th&gt;
&lt;th&gt;CPU型号&lt;/th&gt;
&lt;th&gt;CPU核数&lt;/th&gt;
&lt;t"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="侯锐的思考与分享" type="application/atom+xml"></head><body><div class="container"><header class="header"><div class="blog-title"><a href="/" class="logo">侯锐的思考与分享</a><div class="subtitle"></div></div><nav class="navbar"><ul class="menu"><li class="menu-item"><a href="/" class="menu-item-link" data-no-instant>主页</a></li><li class="menu-item"><a href="/atom.xml" class="menu-item-link" data-no-instant>订阅</a></li><li class="menu-item"><a href="/search" class="menu-item-link" data-no-instant>搜索</a></li></ul></nav></header><article class="post"><div class="post-title"><h1 class="article-title">Elasticsearch不同版本的压力测试与结果对比</h1></div><div class="post-meta"><span class="post-time">2020-05-16</span></div><div class="post-content"><p>公司目前所使用的Elasticsearch（以下简称ES）版本是在2015年的时候选择的，当时选择了ES的最新版本1.5.2。随着ES官方的快速发展，ES也已经推出了很多新的版本，这些新版本往往伴随着一些新特性的发布以及性能的提升，为了使用到这些新特性，我们决定将ES的版本升级到7.5.2。</p><p>ES版本升级会遇到API不兼容的问题，我们的解决办法是在业务和ES之间增加一层_搜索平台_来做接口兼容。此外我们在版本升级之前还需要了解一下ES-7.5.2相对于ES-1.5.2有多少性能提升，所以我们需要针对这两个版本做一下性能测试并对结果进行对比。我们使用如下的四台负载来做性能测试</p><div style="overflow:auto"><style>div table{white-space:nowrap}</style><table><thead><tr><th>序号</th><th>节点IP</th><th>CPU型号</th><th>CPU核数</th><th>内存</th><th>硬盘</th><th>操作系统</th></tr></thead><tbody><tr><td>1</td><td>172.19.66.58</td><td>Intel(R) Xeon(R) CPU E5645 @2.40GHz</td><td>2</td><td>3079520kB</td><td>14G</td><td>GNU&#x2F;Linux 3.10.0-957.21.3.el7.x86_64</td></tr><tr><td>2</td><td>172.19.66.70</td><td>Intel(R) Xeon(R) CPU E5645 @2.40GHz</td><td>2</td><td>3079524kB</td><td>14G</td><td>GNU&#x2F;Linux 3.10.0-957.21.3.el7.x86_64</td></tr><tr><td>3</td><td>172.19.66.77</td><td>Intel(R) Xeon(R) CPU E5645 @2.40GHz</td><td>2</td><td>3079524kB</td><td>14G</td><td>GNU&#x2F;Linux 3.10.0-957.21.3.el7.x86_64</td></tr><tr><td>4</td><td>172.19.66.133</td><td>Intel(R) Xeon(R) CPU E5645 @2.40GHz</td><td>2</td><td>3079524kB</td><td>14G</td><td>GNU&#x2F;Linux 3.10.0-957.21.3.el7.x86_64</td></tr></tbody></table></div><p>使用time和dd命令测试负载的磁盘性能</p><pre><code># 测试磁盘的写入性能
time dd if=/dev/zero of=test.data bs=8k count=10000 oflag=direct
# 测试磁盘的读取性能
time dd if=test.data of=/dev/null bs=8k count=10000 iflag=direct
</code></pre><p>通过测试可知以上四台负载的磁盘读写性能基本一致。</p><h3 id="压测前的环境准备"><a href="#压测前的环境准备" class="headerlink" title="压测前的环境准备"></a>压测前的环境准备</h3><h4 id="创建索引和数据"><a href="#创建索引和数据" class="headerlink" title="创建索引和数据"></a>创建索引和数据</h4><p>1号和2号节点安装ES-1.5.2集群，3号和4号节点安装ES-7.5.2集群。两个集群各自的两个节点均设置为master-eligible和data节点，并且JVM的堆内存都设置为<strong>1GB</strong>。分别向两个集群写入相同的测试数据112万条，对于text类型两个集群都使用ES默认的分词器。两个集群的两个索引的mapping基本上一致，我把<a target="_blank" rel="noopener" href="https://gist.github.com/RitterHou/0f007bc1b2ec621b897ba9d94ea2802d">1.5.2</a>和<a target="_blank" rel="noopener" href="https://gist.github.com/RitterHou/0fc582b9285a5c7b16becde3eb3a819a">7.5.2</a>这两个索引的mapping都放在了gist上面以供参考。</p><h4 id="创建压测环境"><a href="#创建压测环境" class="headerlink" title="创建压测环境"></a>创建压测环境</h4><p>我们使用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ApacheBench">ApacheBench (ab)</a> 来实现压测功能，为了方便操作我们利用ab实现了一个测试脚本 <a target="_blank" rel="noopener" href="https://gist.github.com/RitterHou/15ead449731ecc2b47bf2348f4e0d379">test.sh</a>，在测试脚本中我们使用了query.json文件中的ES查询DSL来实现ES不同类型查询的性能测试，后面我们会修改query.json文件中的DSL来实现不同的查询测试。</p><h3 id="进行压测"><a href="#进行压测" class="headerlink" title="进行压测"></a>进行压测</h3><p>压测使用的客户机为MacBookPro，客户机和ES集群位于同一个局域网，因此可以保证网络带宽不会成为瓶颈。客户机的具体配置如下</p><pre><code>macOs Catalina 10.15.4 (19E287)
MacBook Pro (Retina, 13-inch, Early 2015)
2.7 GHz Dual-Core Intel Core i5
8 GB 1867 MHz DDR3
</code></pre><p>具体的测试结果如下，我们修改query.json的DSL来实现不同类型操作的测试。</p><h4 id="term-level"><a href="#term-level" class="headerlink" title="term-level"></a>term-level</h4><h5 id="term"><a href="#term" class="headerlink" title="term"></a>term</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;acctId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A00000000000&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>修改query.json的内容如上并且执行命令</p><pre><code>./test.sh
</code></pre><p>随后我们可以得到脚本的执行结果，因为执行结果内容比较多所以我们只挑一些关键性的部分进行了解。完整的执行结果可以在 <a target="_blank" rel="noopener" href="https://gist.github.com/RitterHou/89fa24f7db5bbeffa22fd1a58a180739">gist上面</a> 看到。</p><pre><code>Elasticsearch-1.5.2 &gt;&gt;&gt; 172.19.66.70
Requests per second:    165.87 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%     343
66%     399
75%     421
80%     454
90%     547
95%     620
98%     687
99%     784
100%    905 (longest request)

Elasticsearch-7.5.2 &gt;&gt;&gt; 172.19.66.77
Requests per second:    1049.51 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%     53
66%     61
75%     68
80%     73
90%     87
95%     100
98%     118
99%     129
100%    202 (longest request)
</code></pre><p>可以看到在并发为60的情况下，执行压测10秒钟，1.5.2的QPS为165.87，7.5.2的QPS为1049.51，此外7.5.2的99%的请求耗时都是在130ms以下的，由此可以证明7.5.2相较于1.5.2在term查询上确实有很大的性能提升。</p><h5 id="range"><a href="#range" class="headerlink" title="range"></a>range</h5><p>query.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;createdTimeStr&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2020-01-01T00:00:00.000+0800&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>性能测试结果</p><pre><code>Elasticsearch-1.5.2 &gt;&gt;&gt; 172.19.66.70
Requests per second:    1237.86 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%     45
66%     52
75%     58
80%     62
90%     75
95%     85
98%     101
99%     113
100%    189 (longest request)

Elasticsearch-7.5.2 &gt;&gt;&gt; 172.19.66.77
Requests per second:    1099.03 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%     47
66%     54
75%     59
80%     63
90%     75
95%     86
98%     102
99%     120
100%    166 (longest request)
</code></pre><p>可以看出7.5.2在range查询上有一定的性能提升，但是提升并不明显。</p><h4 id="match"><a href="#match" class="headerlink" title="match"></a>match</h4><p>query.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;userName.analyzed&quot;</span><span class="punctuation">:</span> <span class="string">&quot;江苏千米&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>性能测试结果</p><pre><code>Elasticsearch-1.5.2 &gt;&gt;&gt; 172.19.66.70
Requests per second:    789.62 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%     74
66%     92
75%     107
80%     115
90%     132
95%     148
98%     169
99%     187
100%    336 (longest request)

Elasticsearch-7.5.2 &gt;&gt;&gt; 172.19.66.77
Requests per second:    1229.56 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%     44
66%     52
75%     57
80%     62
90%     72
95%     85
98%     107
99%     135
100%    275 (longest request)
</code></pre><p>由上面的结果可见7.5.2对match查询也是有一定的性能提升的。</p><h4 id="aggregation操作"><a href="#aggregation操作" class="headerlink" title="aggregation操作"></a>aggregation操作</h4><h5 id="metrics"><a href="#metrics" class="headerlink" title="metrics"></a>metrics</h5><p>query.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;balance_stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;extended_stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;balance&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>性能测试结果</p><pre><code>Elasticsearch-1.5.2 &gt;&gt;&gt; 172.19.66.70
Requests per second:    32.67 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%    1838
66%    1938
75%    1970
80%    1972
90%    2427
95%    2555
98%    2597
99%    3486
100%   3806 (longest request)

Elasticsearch-7.5.2 &gt;&gt;&gt; 172.19.66.77
Requests per second:    1393.98 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%     41
66%     48
75%     53
80%     56
90%     65
95%     74
98%     84
99%     93
100%    141 (longest request)
</code></pre><p>7.5.2在指标聚合上的速度提升也十分的可观。</p><h5 id="bucket"><a href="#bucket" class="headerlink" title="bucket"></a>bucket</h5><p>query.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;typeName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;balanceTypeName&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">50</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>性能测试结果</p><pre><code>Elasticsearch-1.5.2 &gt;&gt;&gt; 172.19.66.70
Requests per second:    79.98 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%    721
66%    1015
75%    1171
80%    1258
90%    1488
95%    1571
98%    1600
99%    1618
100%   1643 (longest request)

Elasticsearch-7.5.2 &gt;&gt;&gt; 172.19.66.77
Requests per second:    1629.80 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%     34
66%     40
75%     45
80%     48
90%     57
95%     65
98%     77
99%     86
100%    153 (longest request)
</code></pre><p>7.5.2在桶聚合上也有着很好的性能优化效果。</p><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>从上面的term、range、match、metric、bucket的测试结果中我们可以看到，除了range之外其余的几个DSL在7.5.2都有了较大的性能提升。但是我们也要清醒地认识到，我们在上面的单次性能测试中使用的都是完全一样的DSL，这就可能会使得ES中的缓存生效，因此该性能测试可能无法完全展现出真实环境中的ES性能，因为在真实环境中ES的缓存可能并不能像这里测试的这样完美的生效。</p><p>此外，由于这里的机器资源有限，我们只能做一个简单的性能对比实验，证明7.5.2的性能确实是优于1.5.2的。真正的ES-7.5.2集群的性能极限还要等到_搜索平台_的兼容性测试完成后，这时候我们可以搭建一个真正的生产环境的7.5.2集群，然后对此集群进行极限压测，等后面做了我会再做一份笔记。</p><h4 id="数据写入的性能测试"><a href="#数据写入的性能测试" class="headerlink" title="数据写入的性能测试"></a><em>数据写入的性能测试</em></h4><p>上面我们测试了ES的数据检索和聚合的性能，下面我们也对ES的数据写入性能做一个测试。创建data.json并保存如下的数据</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">86523</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;普通高等教育“十一五”国家级规划教材配套参考书：电工电子学学习辅导与习题解答（第3版）&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;publish&quot;</span><span class="punctuation">:</span> <span class="string">&quot;高等教育出版社&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张伯尧，叶挺秀&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;《电工电子学学习辅导与习题解答(第3版)》&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">86.9</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;createdTimeStr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2020-01-01T12:00:00.000+0800&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;createdTime&quot;</span><span class="punctuation">:</span> <span class="number">1547873713709</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;college&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sellOut&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;students&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;王博文&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;徐晓静&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;路小楠&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>使用ab测试1.5.2的集群写入性能</p><pre><code>ab -n 50000 -c 200 -p data.json -T &#39;application/json&#39; http://172.19.66.70:9200/books/Book
</code></pre><p>性能报告如下</p><pre><code>Time taken for tests:   26.680 seconds
Requests per second:    1874.06 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%     72
66%     85
75%     95
80%     101
90%     123
95%     147
98%     1236
99%     1276
100%    3652 (longest request)
</code></pre><p>使用ab测试7.5.2的集群写入性能</p><pre><code>ab -n 50000 -c 200 -p data.json -T &#39;application/json&#39; http://172.19.66.77:9200/books/_doc
</code></pre><p>性能报告如下</p><pre><code>Time taken for tests:   103.203 seconds
Requests per second:    484.48 [#/sec] (mean)
Percentage of the requests served within a certain time (ms)
50%     344
66%     387
75%     438
80%     478
90%     615
95%     739
98%     979
99%     1097
100%    2436 (longest request)
</code></pre><p>很奇怪的是ES-7.5.2的数据写入性能明显低于ES-1.5.2，为了规避掉机器之间的细微的差异，我把ES-7.5.2安装在节点1和节点2之上，之后停止ES-1.5.2集群同时启动ES-7.5.2集群，然后把数据写到新的7.5.2的集群中去，测试结果和上面还是基本一致。具体原因暂时还不清楚，后面再做进一步的深入了解。</p><h5 id="数据写入慢的原因"><a href="#数据写入慢的原因" class="headerlink" title="数据写入慢的原因"></a>数据写入慢的原因</h5><p>我们删除上面的测试中所创建的books索引，之后给每个索引只创建一条文档</p><pre><code>ab -n 1 -c 1 -p data.json -T &#39;application/json&#39; http://172.19.66.70:9200/books/Book
ab -n 1 -c 1 -p data.json -T &#39;application/json&#39; http://172.19.66.77:9200/books/_doc
</code></pre><p>只写入一条数据我们发现1.5.2也是快于7.5.2的集群的，之后我们使用如下接口观察我们写入的数据的段文件情况，首先是1.5.2集群</p><pre><code>http://172.19.66.70:9200/books/_segments
</code></pre><p>得到1.5.2的段文件信息如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;indices&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;books&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;0&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STARTED&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;primary&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fn-qbetJSyS7Qn6qb8rcaQ&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_committed_segments&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_search_segments&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;segments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;_0&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;generation&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;num_docs&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;deleted_docs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;size_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">9870</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;memory_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">12898</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;committed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;search&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4.10.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;compound&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STARTED&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;primary&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PvI9366jTQKbFXWF2HRg6w&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_committed_segments&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_search_segments&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;segments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;_0&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;generation&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;num_docs&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;deleted_docs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;size_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">9870</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;memory_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">12898</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;committed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;search&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4.10.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;compound&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;1&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STARTED&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;primary&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fn-qbetJSyS7Qn6qb8rcaQ&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_committed_segments&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_search_segments&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;segments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STARTED&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;primary&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PvI9366jTQKbFXWF2HRg6w&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_committed_segments&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_search_segments&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;segments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>从上面的结果中我们可以看到这条文档被保存到了books索引的0号分片中，这个分片包含了primary和replica两份数据，1号分片中的数据则为空。我们可以看到0号分片的主备两个分片的 segments.size_in_bytes 的值均为9870，这代表了segment在磁盘上占用的空间大小。</p><p>了解了以上信息之后，我们继续获得7.5.2的段文件信息</p><pre><code>http://172.19.66.77:9200/books/_segments
</code></pre><p>得到的7.5.2的段文件信息如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;indices&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;books&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;0&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STARTED&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;primary&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sLtK-N1eSFiGNV7PeA1ntg&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_committed_segments&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_search_segments&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;segments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STARTED&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;primary&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HNJ8oebqSRGO6C9YJbjCFA&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_committed_segments&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_search_segments&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;segments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;1&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STARTED&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;primary&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sLtK-N1eSFiGNV7PeA1ntg&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_committed_segments&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_search_segments&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;segments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;_0&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;generation&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;num_docs&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;deleted_docs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;size_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">11863</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;memory_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">5007</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;committed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;search&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.3.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;compound&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;Lucene50StoredFieldsFormat.mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BEST_SPEED&quot;</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;STARTED&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;primary&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HNJ8oebqSRGO6C9YJbjCFA&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_committed_segments&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;num_search_segments&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;segments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;_0&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;generation&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;num_docs&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;deleted_docs&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;size_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">11863</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;memory_in_bytes&quot;</span><span class="punctuation">:</span> <span class="number">5007</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;committed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;search&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.3.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;compound&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;Lucene50StoredFieldsFormat.mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BEST_SPEED&quot;</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>7.5.2集群的books索引的文档分配在了分片1上，同样分片1也包含了主副两个分片。我们可以看到7.5.2的段文件占用的磁盘空间为11863，比1.5.2的9870要大一些，这是为什么呢？按道理来说Lucene从版本4.10.4升级到版本8.3.0，占用空间应该有一定程度上的优化才对，至少也不应该是占用空间变大了啊。</p><p>通过查找资料，我们可以知道在新版本的Elasticsearch中，为了优化ES的<strong>排序</strong>和<strong>聚合</strong>的速度而引入了<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/doc-values.html">Doc values</a>属性，该属性是在文档索引时生成的，目的是为了替代以前在文档查询时才生成的<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/fielddata.html">Fielddata</a>属性。</p><p>我们可以对字段的mapping属性添加</p><pre><code>&quot;doc_values&quot;: false
</code></pre><p>这样可以禁用字段的doc_values属性，在禁用了7.5.2的字段的doc_values之后，段文件占用空间明显减小，索引速度也有明显的提升。</p><p>BUT!!!</p><p>通过以上的配置之后，7.5.2的数据索引速度仍然只是1.5.2的一半😶，具体原因还需进一步的分析😢。</p><p>5月19日补充：</p><p>关闭两个集群的refresh_interval（关闭自动refresh之后，写入到索引的数据不会被查询到，除非手动的执行了refresh操作之后才可以）</p><pre><code>PUT /books/_settings

&#123;
    &quot;refresh_interval&quot;: -1
&#125;
</code></pre><p>同时关闭7.5.2的doc_values，并且只保存了long类型的数据以避免分词器的影响，之后测试结果发现仍然是7.5.2的时间更长。不过此时我们使用如下的接口查询索引的详细信息</p><pre><code>GET /books/_stats
</code></pre><p>可以发现两个索引的 indexing.index_time_in_millis 的值其实是一样呢，这是为啥呢。。。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016054136">Apache Bench 安装与使用</a><br><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/17381.html">性能测试应该怎么做？</a></p><p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/JJkTPj2ja7PAHFEUGDcb">滴滴 ElasticSearch 平台跨版本升级以及平台重构之路</a><br><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/query-dsl.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.5/query-dsl.html</a><br><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations.html</a></p></div><div class="post-copyright"><div><strong>本文链接：</strong> <span title="Elasticsearch不同版本的压力测试与结果对比">https://www.nosuchfield.com/2020/05/16/Elasticsearch-performance-comparison-of-different-versions/</span></div><div><strong>版权声明： </strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处！</div></div><style>summary{cursor:pointer;margin-bottom:10px}summary:focus{outline:0}</style><script src="/js/code-enhancer.js"></script><script src="/js/pangu.min.js"></script><script>pangu.spacingPage()</script><script>function backToTop(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script defer src="https://cloud.umami.is/script.js" data-website-id="267e4aaf-8cb5-464d-b16c-89e66283e505"></script><div class="post-footer"><ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/ElasticSearch/" rel="tag">ElasticSearch</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/" rel="tag">压力测试</a></li></ul><span onclick="backToTop()" class="top">返回顶部</span></div></article><footer><span>&copy; 2015 - 2025</span> <span class="author">Raymond</span> <span style="float:right"><span class="upyun">本网站由<a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"> <img src="/images/others/upyun.png"></a>提供CDN加速&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <a class="filing" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备15057335号</a> <a class="github" href="https://github.com/RitterHou" target="_blank">GitHub</a></span></footer></div></body></html>