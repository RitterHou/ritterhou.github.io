<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><title>在使用elasticsearch-py时不对master节点进行读写 - 侯锐的思考与分享</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="keywords" content="ElasticSearch,Python"><meta name="description" content="&lt;p&gt;最近我们搭建了一个新的Elasticsearch（以下简称ES）集群，集群中有3个master节点和6个data节点，集群使用到的ES版本为7.5.2。其中master节点JVM的堆内存设置为2GB，data节点JVM的堆内存设置为30GB，master和data节点都只用作单一的节点角色（即节点不会同时是master和data两种角色）。因为master不存储数据，所以我们给master三台负载的配置都比较低。&lt;/p&gt;
&lt;h3 id=&#34;master配置不够导致读写出错&#34;&gt;&lt;a href=&#34;#master配置不够导致读写出错&#34; class=&#34;headerlink&#34; title=&#34;master配置不够导致读写出错&#34;&gt;&lt;/a&gt;master配置不够导致读写出错&lt;/h3&gt;&lt;p&gt;我们在操作ES集群的时候使用了&lt;a href=&#34;https://github.com/elastic/elasticsearch-py&#34;&gt;elasticsearch-py&lt;/a&gt;这个ES的Python操作库，问题在于这个库在操作ES的时候会先根据ES的&lt;code&gt;/_nodes/_all/http&lt;/code&gt;接口"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="侯锐的思考与分享" type="application/atom+xml"></head><body><div class="container"><header class="header"><div class="blog-title"><a href="/" class="logo">侯锐的思考与分享</a><div class="subtitle"></div></div><nav class="navbar"><ul class="menu"><li class="menu-item"><a href="/" class="menu-item-link" data-no-instant>主页</a></li><li class="menu-item"><a href="/atom.xml" class="menu-item-link" data-no-instant>订阅</a></li><li class="menu-item"><a href="/search" class="menu-item-link" data-no-instant>搜索</a></li></ul></nav></header><article class="post"><div class="post-title"><h1 class="article-title">在使用elasticsearch-py时不对master节点进行读写</h1></div><div class="post-meta"><span class="post-time">2020-09-22</span></div><div class="post-content"><p>最近我们搭建了一个新的Elasticsearch（以下简称ES）集群，集群中有3个master节点和6个data节点，集群使用到的ES版本为7.5.2。其中master节点JVM的堆内存设置为2GB，data节点JVM的堆内存设置为30GB，master和data节点都只用作单一的节点角色（即节点不会同时是master和data两种角色）。因为master不存储数据，所以我们给master三台负载的配置都比较低。</p><h3 id="master配置不够导致读写出错"><a href="#master配置不够导致读写出错" class="headerlink" title="master配置不够导致读写出错"></a>master配置不够导致读写出错</h3><p>我们在操作ES集群的时候使用了<a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-py">elasticsearch-py</a>这个ES的Python操作库，问题在于这个库在操作ES的时候会先根据ES的<code>/_nodes/_all/http</code>接口获取集群所有节点的HTTP接口地址，之后利用这些接口地址对ES进行读写。当然elasticsearch-py会在这些接口地址间做负载均衡以及错误重试等等操作，但是<code>/_nodes/_all/http</code>接口会同时返回master、data以及一些其它角色节点的HTTP接口地址，这就导致elasticsearch-py在后面操作集群的过程中既会读写data节点，也会读写master节点。</p><p>因为我们master节点的配置很低，所以一旦在master节点上面进行读写操作，那么master节点的压力尤其是内存的压力就会比较大，经常就会出现<code>circuit_breaking_exception</code>的错误。</p><p>解决办法就是利用的elasticsearch-py的<code>host_info_callback</code>参数来过滤要操作的节点，具体使用方式如下</p><p>在创建ES连接对象的时候指定回调方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"></span><br><span class="line">es = Elasticsearch(</span><br><span class="line">    host_info_callback=not_master_nodes,  <span class="comment"># 指定操作的回调方法</span></span><br><span class="line">    sniff_on_start=<span class="literal">True</span>, sniff_on_connection_fail=<span class="literal">True</span>, sniffer_timeout=<span class="number">60</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>之后我们创建<code>not_master_nodes</code>过滤方法如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">not_master_nodes</span>(<span class="params">node_info, host</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    由于master节点的性能较差，所以过滤掉master节点</span></span><br><span class="line"><span class="string">    :param node_info:</span></span><br><span class="line"><span class="string">    :param host:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    roles = node_info.get(<span class="string">&#x27;roles&#x27;</span>, [])</span><br><span class="line">    <span class="keyword">return</span> host <span class="keyword">if</span> <span class="string">&#x27;master&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> roles <span class="keyword">else</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure><p>逻辑非常简单，就是把<code>roles</code>属性中包含了<code>master</code>的节点给剔除即可。</p><p>elasticsearch-py会在<a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-py/blob/7.5.1/elasticsearch/transport.py#L240-L259">_get_host_info</a>方法中<a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-py/blob/7.5.1/elasticsearch/transport.py#L259">调用host_info_callback方法</a>，并且在<a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-py/blob/7.5.1/elasticsearch/transport.py#L261-L282">sniff_hosts</a>方法中<a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-py/blob/7.5.1/elasticsearch/transport.py#L273">对不符合要求的节点进行过滤</a>，具体实现逻辑可以参考前面的源码连接。</p><p>添加了<code>host_info_callback</code>属性之后，elasticsearch-py就再也不会操作master节点了。这样带来了两个好处</p><ol><li>master节点的压力降低，提升了master节点的稳定性</li><li>读写操作也不会因为master节点的内存不足而报错了，提升了读写操作的稳定性</li></ol><p>我们把上面的代码上线之后，通过<code>nload -u M</code>命令查看三台master节点的网速，发现三个节点的平均网速均从<code>0.3 MByte/s</code>降到了<code>0.02 MByte/s</code>，网速下降非常明显。此外通过命令<code>netstat -an | grep 9200</code>也看不到任何与master节点的9200端口的连接了，说明此时elasticsearch-py已经不再连接master节点了。</p><h3 id="为什么之前从来没有出过这个问题？"><a href="#为什么之前从来没有出过这个问题？" class="headerlink" title="为什么之前从来没有出过这个问题？"></a>为什么之前从来没有出过这个问题？</h3><p>我们使用ES已经很久了，为什么之前的1.5.2版本的集群都很正常，但是到了7.5.2版本的集群上就会出现master节点内存不足的错误呢？带着这样的疑问我们也查看了一下1.5.2版本的elasticsearch-py的源码，发现在1.5.2的源码中同样会<a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-py/blob/1.5.0/elasticsearch/transport.py#L230-L232">根据host_info_callback方法来过滤节点</a>，区别在于1.5.2的源码中在创建Transport对象的时候会给host_info_callback参数设置一个默认值：<a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-py/blob/1.5.0/elasticsearch/transport.py#L46">host_info_callback&#x3D;get_host_info</a>。</p><p>get_host_info方法在源码中已经<a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-py/blob/1.5.0/elasticsearch/transport.py#L15-L36">定义好了</a>，这里摘录如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_host_info</span>(<span class="params">node_info, host</span>):</span><br><span class="line">    attrs = node_info.get(<span class="string">&#x27;attributes&#x27;</span>, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ignore master only nodes</span></span><br><span class="line">    <span class="keyword">if</span> (attrs.get(<span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;true&#x27;</span>) == <span class="string">&#x27;false&#x27;</span> <span class="keyword">and</span></span><br><span class="line">        attrs.get(<span class="string">&#x27;client&#x27;</span>, <span class="string">&#x27;false&#x27;</span>) == <span class="string">&#x27;false&#x27;</span> <span class="keyword">and</span></span><br><span class="line">        attrs.get(<span class="string">&#x27;master&#x27;</span>, <span class="string">&#x27;true&#x27;</span>) == <span class="string">&#x27;true&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> host</span><br></pre></td></tr></table></figure><p>可以看到在1.5.2版本的elasticsearch-py中，库本身就已经帮我们过滤掉了纯master节点了，也就是说1.5.2是不会读写纯粹的master节点的，这也难怪为什么我们之前从来没有遇到过这个问题了。至于为什么在后续版本中elasticsearch-py把这个特性去掉了，我猜也许是为了避免让库对用户的操作进行过多的干涉吧，因为想不想读master节点这种事情本来也应该交给用户来决定而不是库本身擅自决定的。</p><h3 id="应用本身的一些配置"><a href="#应用本身的一些配置" class="headerlink" title="应用本身的一些配置"></a>应用本身的一些配置</h3><h4 id="如果使用两个版本的elasticsearch-py"><a href="#如果使用两个版本的elasticsearch-py" class="headerlink" title="如果使用两个版本的elasticsearch-py"></a>如果使用两个版本的elasticsearch-py</h4><p>我们的应用现在在同时读写1.5.2和7.5.2这两个版本的集群，因为使用两个版本的elasticsearch-py会导致包冲突，我们的解决办法是把这两个版本的elasticsearch-py的源码直接复制到我们应用的源码中，两个版本的源码分别放在应用中的elasticsearch1和elasticsearch7这两个模块的文件夹中，之后想要调用时直接使用<code>import elasticsearch1</code>和<code>import elasticsearch7</code>导入模块即可。</p><h4 id="如何配置seed-hosts"><a href="#如何配置seed-hosts" class="headerlink" title="如何配置seed hosts"></a>如何配置seed hosts</h4><p>我们现在已经知道了elasticsearch-py操作ES分为两个步骤</p><ol><li>通过配置的seed hosts访问ES集群，根据ES提供的接口获取到ES集群所有节点的HTTP接口，之后根据需要剔除掉一些节点（这一步在1.5.2和7.5.2中有所差异），最终得到一个符合我们需要的ES集群的节点HTTP接口列表（在elasticsearch-py中这一步操作对应的方法叫做<strong>sniff_hosts</strong>）</li><li>通过第一步拿到的节点列表来对ES集群进行真正的读写操作</li></ol><p>由此我们可以知道我们配置的seed hosts并不是一定会作为真正的读写节点的，真正读写的节点会在第一步操作中通过接口获取并进行判断得到的。所以我们现在在<strong>设置seed hosts时会把seed hosts设置为所有的master节点地址</strong>，这样的好处在于master节点基本上不会更换，而data节点可能会频繁的变更（例如更换硬盘、增加配置等等），使用master节点作为seed hosts就保证了可以在data节点变更时不再需要修改配置。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>其实本文核心过程就是这几部分</p><ol><li>设置seed hosts</li><li>以seed hosts为基础，根据sniff_hosts方法拿到集群的全部节点</li><li>对拿到的全部节点进行过滤，过滤之后剩下的就是我们想要的节点</li><li>通过过滤之后的节点对集群进行真正的操作</li></ol><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/how-to-only-query-on-data-nodes-by-elasticsearch-py/249293">https://discuss.elastic.co/t/how-to-only-query-on-data-nodes-by-elasticsearch-py/249293</a><br><a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-py/issues/1378">https://github.com/elastic/elasticsearch-py/issues/1378</a></p><h4 style="color:red">2020-09-24补充</h4><p>后来经过研究发现其实在elasticsearch-py的7.5.2版本的源码中也是定义了<a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-py/blob/7.5.1/elasticsearch/transport.py#L17-L34">get_host_info</a>方法的，摘录如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_host_info</span>(<span class="params">node_info, host</span>):</span><br><span class="line">    <span class="comment"># ignore master only nodes</span></span><br><span class="line">    <span class="keyword">if</span> node_info.get(<span class="string">&quot;roles&quot;</span>, []) == [<span class="string">&quot;master&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> host</span><br></pre></td></tr></table></figure><p>上面的逻辑表示，只要一个节点的roles是<code>[&quot;master&quot;]</code>那么默认就会被剔除。只是我调用ES的接口<code>/_nodes/_all/http</code>查看了一下7.5.2集群的配置，发现我的master节点的roles是<code>[&quot;master&quot;, &quot;ml&quot;]</code>，还附带了一个<code>ml</code>的角色，因此不能匹配上面的条件，导致我的master被保留了下来。</p><p>知道了原理之后，我们就知道了解决办法了。除了像上面重写过滤方法之外，我们也可以把master节点的<code>ml</code>的角色设置为false，根据<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/modules-node.html#master-node">ES文档</a>，我们只需要在master节点中添加如下设置即可</p><pre><code>node.ml: false
</code></pre><h4 style="color:red">2020-11-03补充</h4><h3 id="通过总结我们可以得到一个最佳实践"><a href="#通过总结我们可以得到一个最佳实践" class="headerlink" title="通过总结我们可以得到一个最佳实践"></a>通过总结我们可以得到一个最佳实践</h3><p>对于集群本身，我们先创建三个master节点，它们的配置如下</p><pre><code>discovery.seed_hosts: [&#123;&#123; alias.MasterIPList &#125;&#125;]
cluster.initial_master_nodes: [&#123;&#123; alias.MasterIPList &#125;&#125;]
</code></pre><p>集群在刚刚启动的时候master节点的seed_hosts和initial_master_nodes都需要设置为master节点的地址列表。在集群启动完毕之后，我们可以添加data节点或者ingest节点等等其它的节点，它们只需要把seed_hosts设置为当前的master节点即可</p><pre><code>discovery.seed_hosts: [&#123;&#123; alias.MasterIPList &#125;&#125;]
</code></pre><p>而对于客户端，同样我们在设置ES地址的时候也只需要设置master节点的地址就可以了</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;elasticsearch_hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> alias.MasterIPList <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>es的Python客户端会使用master的节点地址作为种子，通过种子获取了data节点的地址之后再在data节点上面进行真正的读写操作。</p><p>附上我们目前使用的elasticsearch.yml和jvm.options配置文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======================== Elasticsearch Configuration =========================</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> Elasticsearch comes with reasonable defaults for most settings.</span></span><br><span class="line"><span class="comment">#       Before you set out to tweak and tune the configuration, make sure you</span></span><br><span class="line"><span class="comment">#       understand what are you trying to accomplish and the consequences.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The primary way of configuring a node is via this file. This template lists</span></span><br><span class="line"><span class="comment"># the most important settings you may want to configure for a production cluster.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please consult the documentation for further information on configuration options:</span></span><br><span class="line"><span class="comment"># https://www.elastic.co/guide/en/elasticsearch/reference/index.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Cluster -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for your cluster:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">cluster.name:</span> &#123;&#123; <span class="string">attrs.t_clustername</span> &#125;&#125;</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ------------------------------------ Node ------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for the node:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">node.name:</span> &#123;&#123; <span class="string">cHost.name</span> &#125;&#125;</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Add custom attributes to the node:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">node.master:</span> &#123;&#123; <span class="string">attrs.t_is_master</span> &#125;&#125;</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">node.data:</span> &#123;&#123; <span class="string">attrs.t_is_data</span> &#125;&#125;</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">node.ingest:</span> &#123;&#123; <span class="string">attrs.t_is_ingest</span> &#125;&#125;</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">node.ml:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ----------------------------------- Paths ------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to directory where to store the data (separate multiple locations by comma):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/home/elasticsearch/data</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Path to log files:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/home/elasticsearch/elasticsearch/logs</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ----------------------------------- Memory -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Lock the memory on startup:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="attr">bootstrap.system_call_filter:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Make sure that the heap size is set to about half the memory available</span></span><br><span class="line"><span class="comment"># on the system and that the owner of the process is allowed to use this</span></span><br><span class="line"><span class="comment"># limit.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Elasticsearch performs poorly when the system is swapping the memory.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Network -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set the bind address to a specific IP (IPv4 or IPv6):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">network.host:</span> &#123;&#123; <span class="string">cHost.ip</span> &#125;&#125;</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set a custom port for HTTP:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">http.port:</span> &#123;&#123; <span class="string">attrs.t_server_port</span> &#125;&#125;</span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># For more information, consult the network module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># --------------------------------- Discovery ----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Pass an initial list of hosts to perform discovery when this node is started:</span></span><br><span class="line"><span class="comment"># The default list of hosts is [&quot;127.0.0.1&quot;, &quot;[::1]&quot;]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [&#123;&#123; <span class="string">alias.MasterIPList</span> &#125;&#125;]</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Bootstrap the cluster using an initial set of master-eligible nodes:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># cluster.initial_master_nodes: [&#123;&#123; alias.MasterIPList &#125;&#125;]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the discovery and cluster formation module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Gateway -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Block initial recovery after a full cluster restart until N nodes are started:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#gateway.recover_after_nodes: 3</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, consult the gateway module documentation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ---------------------------------- Various -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Require explicit names when deleting indices:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">path.repo:</span> [<span class="string">&quot;/home/elasticsearch/ES_backup/7-5-2&quot;</span>]</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">## JVM configuration</span><br><span class="line"></span><br><span class="line">################################################################</span><br><span class="line">## IMPORTANT: JVM heap size</span><br><span class="line">################################################################</span><br><span class="line">##</span><br><span class="line">## You should always set the min and max JVM heap</span><br><span class="line">## size to the same value. For example, to set</span><br><span class="line">## the heap to 4 GB, set:</span><br><span class="line">##</span><br><span class="line">## -Xms4g</span><br><span class="line">## -Xmx4g</span><br><span class="line">##</span><br><span class="line">## See https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span><br><span class="line">## for more information</span><br><span class="line">##</span><br><span class="line">################################################################</span><br><span class="line"></span><br><span class="line"># Xms represents the initial size of total heap space</span><br><span class="line"># Xmx represents the maximum size of total heap space</span><br><span class="line"></span><br><span class="line">-Xms&#123;&#123;attrs.t_heap_size&#125;&#125;</span><br><span class="line">-Xmx&#123;&#123;attrs.t_heap_size&#125;&#125;</span><br><span class="line"></span><br><span class="line">################################################################</span><br><span class="line">## Expert settings</span><br><span class="line">################################################################</span><br><span class="line">##</span><br><span class="line">## All settings below this section are considered</span><br><span class="line">## expert settings. Don&#x27;t tamper with them unless</span><br><span class="line">## you understand what you are doing</span><br><span class="line">##</span><br><span class="line">################################################################</span><br><span class="line"></span><br><span class="line">## GC configuration</span><br><span class="line">-XX:+UseConcMarkSweepGC</span><br><span class="line">-XX:CMSInitiatingOccupancyFraction=75</span><br><span class="line">-XX:+UseCMSInitiatingOccupancyOnly</span><br><span class="line"></span><br><span class="line">## G1GC Configuration</span><br><span class="line"># NOTE: G1GC is only supported on JDK version 10 or later.</span><br><span class="line"># To use G1GC uncomment the lines below.</span><br><span class="line"># 10-:-XX:-UseConcMarkSweepGC</span><br><span class="line"># 10-:-XX:-UseCMSInitiatingOccupancyOnly</span><br><span class="line"># 10-:-XX:+UseG1GC</span><br><span class="line"># 10-:-XX:G1ReservePercent=25</span><br><span class="line"># 10-:-XX:InitiatingHeapOccupancyPercent=30</span><br><span class="line"></span><br><span class="line">## JVM temporary directory</span><br><span class="line">-Djava.io.tmpdir=$&#123;ES_TMPDIR&#125;</span><br><span class="line"></span><br><span class="line">## heap dumps</span><br><span class="line"></span><br><span class="line"># generate a heap dump when an allocation from the Java heap fails</span><br><span class="line"># heap dumps are created in the working directory of the JVM</span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line"></span><br><span class="line"># specify an alternative path for heap dumps; ensure the directory exists and</span><br><span class="line"># has sufficient space</span><br><span class="line">-XX:HeapDumpPath=data</span><br><span class="line"></span><br><span class="line"># specify an alternative path for JVM fatal error logs</span><br><span class="line">-XX:ErrorFile=logs/hs_err_pid%p.log</span><br><span class="line"></span><br><span class="line">## JDK 8 GC logging</span><br><span class="line">8:-XX:+PrintGCDetails</span><br><span class="line">8:-XX:+PrintGCDateStamps</span><br><span class="line">8:-XX:+PrintTenuringDistribution</span><br><span class="line">8:-XX:+PrintGCApplicationStoppedTime</span><br><span class="line">8:-Xloggc:logs/gc.log</span><br><span class="line">8:-XX:+UseGCLogFileRotation</span><br><span class="line">8:-XX:NumberOfGCLogFiles=32</span><br><span class="line">8:-XX:GCLogFileSize=64m</span><br><span class="line"></span><br><span class="line"># JDK 9+ GC logging</span><br><span class="line">9-:-Xlog:gc*:file=logs/gc.log:t,tags,level:filecount=32,filesize=64m</span><br></pre></td></tr></table></figure></div><div class="post-copyright"><div><strong>本文链接：</strong> <span title="在使用elasticsearch-py时不对master节点进行读写">https://www.nosuchfield.com/2020/09/22/Do-not-read-and-write-to-the-master-nodes-when-using-elasticsearch-py/</span></div><div><strong>版权声明： </strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处！</div></div><style>summary{cursor:pointer;margin-bottom:10px}summary:focus{outline:0}</style><script src="/js/code-enhancer.js"></script><script src="/js/pangu.min.js"></script><script>pangu.spacingPage()</script><script>function backToTop(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script defer src="https://cloud.umami.is/script.js" data-website-id="267e4aaf-8cb5-464d-b16c-89e66283e505"></script><div class="post-footer"><ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/ElasticSearch/" rel="tag">ElasticSearch</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li></ul><span onclick="backToTop()" class="top">返回顶部</span></div></article><footer><span>&copy; 2015 - 2025</span> <span class="author">Raymond</span> <span style="float:right"><span class="upyun">本网站由<a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"> <img src="/images/others/upyun.png"></a>提供CDN加速&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <a class="filing" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备15057335号</a> <a class="github" href="https://github.com/RitterHou" target="_blank">GitHub</a></span></footer></div></body></html>