<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><title>Kubernetes的安装和使用（二） - 侯锐的思考与分享</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="keywords" content="运维,k8s,云原生"><meta name="description" content="&lt;h3 id=&#34;目录&#34;&gt;&lt;a href=&#34;#目录&#34; class=&#34;headerlink&#34; title=&#34;目录&#34;&gt;&lt;/a&gt;目录&lt;/h3&gt;&lt;p&gt;&lt;a href=&#34;/2022/10/30/Kubernetes-installation-and-use-1/&#34;&gt;Kubernetes的安装和使用（一）&lt;/a&gt;&lt;br&gt;&lt;a href=&#34;/2022/10/30/Kubernetes-installation-and-use-2/&#34;&gt;Kubernetes的安装和使用（二）&lt;/a&gt;&lt;br&gt;&lt;a href=&#34;/2022/10/30/Kubernetes-installation-and-use-3/&#34;&gt;Kubernetes的安装和使用（三）&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;k8s的使用&#34;&gt;&lt;a href=&#34;#k8s的使用&#34; class=&#34;headerlink&#34; title=&#34;k8s的使用&#34;&gt;&lt;/a&gt;k8s的使用&lt;/h2&gt;&lt;h3 id=&#34;构建和运行镜像&#34;&gt;&lt;a href=&#34;#构建和运行镜像&#34; class=&#34;headerlink&#34; title=&#34;构建和运行镜像&#34;&gt;&lt;/a&gt;构建和运行镜像&lt;/h3&gt;&lt;p&gt;编写一个"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="侯锐的思考与分享" type="application/atom+xml"></head><body><div class="container"><header class="header"><div class="blog-title"><a href="/" class="logo">侯锐的思考与分享</a><div class="subtitle"></div></div><nav class="navbar"><ul class="menu"><li class="menu-item"><a href="/" class="menu-item-link" data-no-instant>主页</a></li><li class="menu-item"><a href="/atom.xml" class="menu-item-link" data-no-instant>订阅</a></li><li class="menu-item"><a href="/search" class="menu-item-link" data-no-instant>搜索</a></li></ul></nav></header><article class="post"><div class="post-title"><h1 class="article-title">Kubernetes的安装和使用（二）</h1></div><div class="post-meta"><span class="post-time">2022-10-30</span></div><div class="post-content"><h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><p><a href="/2022/10/30/Kubernetes-installation-and-use-1/">Kubernetes的安装和使用（一）</a><br><a href="/2022/10/30/Kubernetes-installation-and-use-2/">Kubernetes的安装和使用（二）</a><br><a href="/2022/10/30/Kubernetes-installation-and-use-3/">Kubernetes的安装和使用（三）</a></p><h2 id="k8s的使用"><a href="#k8s的使用" class="headerlink" title="k8s的使用"></a>k8s的使用</h2><h3 id="构建和运行镜像"><a href="#构建和运行镜像" class="headerlink" title="构建和运行镜像"></a>构建和运行镜像</h3><p>编写一个go程序</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		io.WriteString(w, <span class="string">&quot;[v1] Hello, Kubernetes!&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	log.Printf(<span class="string">&quot;v1 access http://localhost:3000\n&quot;</span>)</span><br><span class="line">	<span class="built_in">panic</span>(http.ListenAndServe(<span class="string">&quot;:3000&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 引入golang的环境，并设置别名</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.20</span>-alpine AS builder</span><br><span class="line"><span class="comment"># 工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /project</span></span><br><span class="line"><span class="comment"># 把当前文件夹的内容都添加到镜像的/project文件夹下</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="comment"># 编译golang源代码</span></span><br><span class="line"><span class="comment"># 设置代理、操作系统、CPU架构、禁用cgo编译</span></span><br><span class="line"><span class="comment"># 设置mod为自动模式，防止因为没有设置go.mod而编译报错</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> GOPROXY=https://goproxy.cn,direct GOOS=linux GOARCH=amd64 CGO_ENABLED=0 GO111MODULE=auto go build -o main -ldflags <span class="string">&quot;-w -extldflags -static&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 引入alpine系统环境</span></span><br><span class="line"><span class="keyword">FROM</span> alpine as prod</span><br><span class="line"><span class="comment"># 从上面的build镜像复制编译好的文件/project/main到当前目录</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /project/main .</span></span><br><span class="line"><span class="comment"># 暴露3000端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br><span class="line"><span class="comment"># 启动main程序</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/main&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>打包镜像</p><pre><code>docker build . -t derobukal/hellok8s:v1
</code></pre><p>执行镜像，并把3000端口暴露出来</p><pre><code>docker run --rm -p 3000:3000 derobukal/hellok8s:v1
</code></pre><p>之后可以用curl访问3000端口，结果正常显示了</p><pre><code>~ curl 127.0.0.1:3000
[v1] Hello, Kubernetes!%   
</code></pre><p>之后可以把这个镜像推送到镜像仓库</p><pre><code>docker login
docker push derobukal/hellok8s:v1
</code></pre><h3 id="使用Pod"><a href="#使用Pod" class="headerlink" title="使用Pod"></a>使用Pod</h3><p>编写pod.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> <span class="comment"># 资源类型为pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">go-http</span> <span class="comment"># 名称，需要在当前命名空间中唯一</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">go</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span> <span class="comment"># pod内的容器组</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">go-http</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">derobukal/hellok8s:v1</span> <span class="comment"># 镜像默认来源 DockerHub</span></span><br></pre></td></tr></table></figure><p>之后创建pod</p><pre><code>~ kc apply -f pod.yaml
pod/go-http created
~ kc get pods
NAME      READY   STATUS    RESTARTS   AGE
go-http   1/1     Running   0          65s
</code></pre><p>然后临时开启端口转发，就可以访问相应的服务了</p><pre><code>~ kc port-forward go-http 3000:3000
Forwarding from 127.0.0.1:3000 -&gt; 3000
Forwarding from [::1]:3000 -&gt; 3000

~ curl http://127.0.0.1:3000
[v1] Hello, Kubernetes!%
</code></pre><p><em>在进行以上测试的时候，如果出现pod启动不了的情况，可能是因为防火墙的原因，可以开启网络代理之后再试。</em></p><h3 id="使用Deployment"><a href="#使用Deployment" class="headerlink" title="使用Deployment"></a>使用Deployment</h3><p>一般来说，pod不会被直接的使用，而是用Deployment来进行相关的操作。</p><p>编写deployment.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># deployment 唯一名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-go-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span> <span class="comment"># 副本数量</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span> <span class="comment"># 管理template下所有 app=hellok8s的pod，（要求和template.metadata.labels完全一致！！！否则无法部署deployment）</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># template 定义一组容器</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">derobukal/hellok8s:v1</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s</span></span><br></pre></td></tr></table></figure><p>部署deployment</p><pre><code>~ kc apply -f deployment.yaml 
deployment.apps/hellok8s-go-http created
~ kc get deployments
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
hellok8s-go-http   2/2     2            2           79s
</code></pre><p><code>kc get pod -o wide</code>可以查看更详细的pod信息。我们可以把配置中的副本数改为3，之后重新执行部署命令，然后查看详细的pod信息如下，可以看到又新增了一个pod</p><pre><code>NAME                                READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES
go-http                             1/1     Running   0          14m     10.244.0.6   minikube   &lt;none&gt;           &lt;none&gt;
hellok8s-go-http-6db476b8cb-4n2nx   1/1     Running   0          4m35s   10.244.0.7   minikube   &lt;none&gt;           &lt;none&gt;
hellok8s-go-http-6db476b8cb-s76jr   1/1     Running   0          4m35s   10.244.0.8   minikube   &lt;none&gt;           &lt;none&gt;
hellok8s-go-http-6db476b8cb-tjqs9   1/1     Running   0          8s      10.244.0.9   minikube   &lt;none&gt;           &lt;none&gt;
</code></pre><p>我们选取任意一个pod进行端口转发，随后请求可以看到结果正常</p><pre><code>~ kc port-forward hellok8s-go-http-6db476b8cb-4n2nx 3000:3000 
Forwarding from 127.0.0.1:3000 -&gt; 3000
Forwarding from [::1]:3000 -&gt; 3000
Handling connection for 3000
</code></pre><h3 id="更新deployment"><a href="#更新deployment" class="headerlink" title="更新deployment"></a>更新deployment</h3><p>我们将golang程序中的<code>v1</code>修改为<code>v2</code>，之后打包新版本镜像并上传</p><pre><code>docker build . -t derobukal/hellok8s:v2
docker push derobukal/hellok8s:v2
</code></pre><p>之后我们修改deployment.yaml中的镜像为<code>derobukal/hellok8s:v2</code>，然后更新部署</p><pre><code>~ kc apply -f deployment.yaml 
deployment.apps/hellok8s-go-http configured
</code></pre><p>可以看到pod都重新部署了</p><pre><code>~ kc get pod -o wide                                         
NAME                               READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES
go-http                            1/1     Running   0          25m   10.244.0.6    minikube   &lt;none&gt;           &lt;none&gt;
hellok8s-go-http-8b44d58c5-5bmx7   1/1     Running   0          34s   10.244.0.12   minikube   &lt;none&gt;           &lt;none&gt;
hellok8s-go-http-8b44d58c5-djfcd   1/1     Running   0          35s   10.244.0.11   minikube   &lt;none&gt;           &lt;none&gt;
hellok8s-go-http-8b44d58c5-rt29z   1/1     Running   0          58s   10.244.0.10   minikube   &lt;none&gt;           &lt;none&gt;
</code></pre><p>之后选取一个Pod进行端口转发，并请求发现返回结果发生了变化</p><pre><code>~ kc port-forward hellok8s-go-http-8b44d58c5-5bmx7 3000:3000 
Forwarding from 127.0.0.1:3000 -&gt; 3000
Forwarding from [::1]:3000 -&gt; 3000
Handling connection for 3000

~ curl http://127.0.0.1:3000
[v2] Hello, Kubernetes!%
</code></pre><h3 id="回滚deployment"><a href="#回滚deployment" class="headerlink" title="回滚deployment"></a>回滚deployment</h3><p>查看版本信息</p><pre><code>~ kc rollout history deployment/hellok8s-go-http
deployment.apps/hellok8s-go-http 
REVISION  CHANGE-CAUSE
1         &lt;none&gt;
2         &lt;none&gt;
</code></pre><p>查看具体版本2</p><pre><code>~ kc rollout history deployment/hellok8s-go-http --revision=2
deployment.apps/hellok8s-go-http with revision #2
Pod Template:
Labels:	app=hellok8s
    pod-template-hash=8b44d58c5
Containers:
hellok8s:
    Image:	derobukal/hellok8s:v2
    Port:	&lt;none&gt;
    Host Port:	&lt;none&gt;
    Environment:	&lt;none&gt;
    Mounts:	&lt;none&gt;
Volumes:	&lt;none&gt;
</code></pre><p>查看具体版本1</p><pre><code>~ kc rollout history deployment/hellok8s-go-http --revision=1
deployment.apps/hellok8s-go-http with revision #1
Pod Template:
Labels:	app=hellok8s
    pod-template-hash=6db476b8cb
Containers:
hellok8s:
    Image:	derobukal/hellok8s:v1
    Port:	&lt;none&gt;
    Host Port:	&lt;none&gt;
    Environment:	&lt;none&gt;
    Mounts:	&lt;none&gt;
Volumes:	&lt;none&gt;
</code></pre><p>回退到版本1</p><pre><code>~ kc rollout undo deployment/hellok8s-go-http --to-revision=1
deployment.apps/hellok8s-go-http rolled back
</code></pre><p>此时查看pod可以发现pod已经发生了改变，访问服务返回的也是v1版本信息了。</p><h3 id="部署失败"><a href="#部署失败" class="headerlink" title="部署失败"></a>部署失败</h3><p>我们构建一个如下的程序</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="built_in">panic</span>(<span class="string">&quot;something went wrong&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后打包一个新版本镜像：<code>docker build . -t derobukal/hellok8s:v_error</code><br>并对这个镜像进行push：<code>docker push derobukal/hellok8s:v_error</code>。</p><p>之后可以简单地使用命令而不修改<code>deployment.yaml</code>文件来重新部署deployment，通过命令修改镜像：</p><pre><code>~ kc set image deployment/hellok8s-go-http hellok8s=derobukal/hellok8s:v2_error  
deployment.apps/hellok8s-go-http image updated
~ kc get pods
NAME                                READY   STATUS              RESTARTS        AGE
go-http                             1/1     Running             1 (7m34s ago)   54m
hellok8s-go-http-55669566cb-l69hx   0/1     ContainerCreating   0               41s
hellok8s-go-http-6db476b8cb-dlr2z   1/1     Running             1 (7m34s ago)   22m
hellok8s-go-http-6db476b8cb-glx7h   1/1     Running             1 (7m34s ago)   22m
hellok8s-go-http-6db476b8cb-sfxnr   1/1     Running             1 (7m34s ago)   22m
</code></pre><p>重新部署之后我们查看pod可以发现，之前的pod仍然在正常运行，而新启动的pod则处于<code>ContainerCreating</code>状态。我们可以直接回退到上一个版本</p><pre><code>~ kc rollout undo deployment/hellok8s-go-http --to-revision=2
deployment.apps/hellok8s-go-http rolled back
~ kc get pods
NAME                                READY   STATUS        RESTARTS      AGE
go-http                             1/1     Running       1 (12m ago)   58m
hellok8s-go-http-55669566cb-l69hx   0/1     Terminating   0             5m17s
hellok8s-go-http-8b44d58c5-74mhw    1/1     Running       0             22s
hellok8s-go-http-8b44d58c5-hfpjj    1/1     Running       0             20s
hellok8s-go-http-8b44d58c5-lzwfm    1/1     Running       0             19s
</code></pre><h3 id="存活探针"><a href="#存活探针" class="headerlink" title="存活探针"></a>存活探针</h3><p>存活探针顾名思义就是用来检查进程的存活情况的，它支持多种方式，下面是一个例子</p><figure class="highlight golang"><figcaption><span>flat</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	started := time.Now()</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/healthz&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		duration := time.Since(started)</span><br><span class="line">		<span class="keyword">if</span> duration.Seconds() &gt; <span class="number">15</span> &#123;</span><br><span class="line">			w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">			w.Write([]<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;error: %v&quot;</span>, duration.Seconds())))</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			w.WriteHeader(<span class="number">200</span>)</span><br><span class="line">			w.Write([]<span class="type">byte</span>(<span class="string">&quot;ok&quot;</span>))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		io.WriteString(w, <span class="string">&quot;[v2] Hello, Kubernetes!&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	http.ListenAndServe(<span class="string">&quot;:3000&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个程序的<code>/healthz</code>接口会在启动15秒钟后开始持续报错，我们使用这个代码创建镜像<code>derobukal/hellok8s:liveness</code>。我们先使用正常的镜像创建depolyment，并设置存活探针配置</p><figure class="highlight yaml"><figcaption><span>flat</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># deployment唯一名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-go-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span> <span class="comment"># 副本数量</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span> <span class="comment"># 管理template下所有 app=hellok8s的pod，（要求和template.metadata.labels完全一致！！！否则无法部署deployment）</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># template 定义一组pod</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">derobukal/hellok8s:v1</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="comment"># http get 探测指定pod提供HTTP服务的路径和端口</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="comment"># 3s后开始探测</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">3</span></span><br><span class="line">            <span class="comment"># 每3s探测一次</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><p>在<code>livenessProbe</code>中我们设置使用httpGet的方式来检查程序的存活状态，并且接口为<code>healthz</code>。启动这个deployment，一切正常</p><pre><code>~ kc get pods
NAME                               READY   STATUS    RESTARTS   AGE
hellok8s-go-http-cf86fc9d6-qjt57   1/1     Running   0          8s
hellok8s-go-http-cf86fc9d6-tnf9r   1/1     Running   0          8s
</code></pre><p>之后我们切换镜像为我们刚刚创建的<code>derobukal/hellok8s:liveness</code>镜像</p><pre><code>kc set image deployment/hellok8s-go-http hellok8s=derobukal/hellok8s:liveness
</code></pre><p>然后可以看到pod会每隔一会儿重启一下</p><pre><code>~ kc get pods
NAME                                READY   STATUS    RESTARTS      AGE
hellok8s-go-http-78fd694d74-j2kr6   1/1     Running   3 (23s ago)   2m41s
hellok8s-go-http-78fd694d74-j5d5x   1/1     Running   3 (19s ago)   91s
</code></pre><p>如果我们这时候再把镜像设置为v1，很快就可以看到pod恢复正常了。</p><h3 id="就绪探针"><a href="#就绪探针" class="headerlink" title="就绪探针"></a>就绪探针</h3><p>就绪探针是用来检测程序是否已经成功启动的，例如程序是否可以接受前端的流量、是否已经可以执行相关的任务了等等。我们编写如下程序并创建<code>derobukal/hellok8s:readiness</code>镜像</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	io.WriteString(w, <span class="string">&quot;[v2] Hello, Kubernetes!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/healthz&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, hello)</span><br><span class="line">	http.ListenAndServe(<span class="string">&quot;:3000&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用如下的配置创建deployment</p><figure class="highlight yaml"><figcaption><span>flat</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># deployment唯一名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-go-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 副本数量</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span> <span class="comment"># 管理template下所有 app=hellok8s的pod，（要求和template.metadata.labels完全一致！！！否则无法部署deployment）</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># template 定义一组pod</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">derobukal/hellok8s:v1</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s</span></span><br><span class="line">          <span class="comment"># 就绪探针</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="comment"># http get 探测pod提供HTTP服务的路径和端口</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">1</span> <span class="comment"># 1s后开始探测</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span> <span class="comment"># 每5s探测一次</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span> <span class="comment"># 单次探测超时，默认1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span> <span class="comment"># 探测失败时，k8s的重试次数，默认3，达到这个次数后 停止探测，并打上未就绪的标签</span></span><br></pre></td></tr></table></figure><p>还是使用<code>/healthz</code>接口进行检测，启动deployment后发现pod正常启动</p><pre><code>~ kc get pods
NAME                                READY   STATUS    RESTARTS   AGE
hellok8s-go-http-7b48477987-2x4ll   1/1     Running   0          12s
hellok8s-go-http-7b48477987-hl4kt   1/1     Running   0          14s
hellok8s-go-http-7b48477987-xdtvl   1/1     Running   0          14s
</code></pre><p>之后修改镜像<code>kc set image deployment/hellok8s-go-http hellok8s=derobukal/hellok8s:readiness</code></p><p>之后发现有两个pod一直无法进入ready状态</p><pre><code>~ kc get pods
NAME                                READY   STATUS    RESTARTS   AGE
hellok8s-go-http-56dd6754c7-6qltj   0/1     Running   0          20s
hellok8s-go-http-56dd6754c7-kmzb2   0/1     Running   0          20s
hellok8s-go-http-7856db556-5d9vr    1/1     Running   0          31s
hellok8s-go-http-7856db556-jctgt    1/1     Running   0          31s
</code></pre><h3 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h3><p>任务用于执行一些job，例如如下的任务</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pods-job</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="comment">#  completions: 3 # 启用它表示串行执行3次</span></span><br><span class="line"><span class="comment">#  parallelism: 3 # 启动它表示并发数，由completions指定总次数</span></span><br><span class="line"><span class="comment">#  backoffLimit: 3 # 限制重试次数，默认6，超过次数则不再启动新pod</span></span><br><span class="line"><span class="comment">#  activeDeadlineSeconds: 10 # 限制job执行时间，超时还不终止则强制终止，并且稍后执行自动删除（若设置），且不受restartPolicy字段影响</span></span><br><span class="line">  <span class="attr">ttlSecondsAfterFinished:</span> <span class="number">10</span> <span class="comment"># 多少秒后自动删除执行成功的job，避免太多不再需要的job累积</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span> <span class="comment"># or OnFailure, 不能是其他值；推荐Never，因为这个策略下控制会启动新的pod，不会删除失败的pod，有助于排查问题；OnFailure是不断重启旧的pod</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo &quot;Start Job!&quot;; sleep 30; echo &quot;Job Done!&quot;&#x27;</span>]</span><br><span class="line">          <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">pods-job-container</span></span><br></pre></td></tr></table></figure><p>如上的任务只是简单的进行了信息的打印</p><pre><code>~ kc apply -f job.yaml       
job.batch/pods-job created
~ kc get pods         
NAME             READY   STATUS              RESTARTS   AGE
pods-job-nthvl   0/1     ContainerCreating   0          7s
~ kc get pods
NAME             READY   STATUS    RESTARTS   AGE
pods-job-nthvl   1/1     Running   0          23s
~ kc get pods
NAME             READY   STATUS    RESTARTS   AGE
pods-job-nthvl   1/1     Running   0          48s
~ kc get pods
NAME             READY   STATUS      RESTARTS   AGE
pods-job-nthvl   0/1     Completed   0          56s
</code></pre><h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><p>定时任务CronJob用于执行定时任务</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pods-cronjob</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span> <span class="comment"># 最小到min级别，这表示每分钟1次</span></span><br><span class="line">  <span class="attr">startingDeadlineSeconds:</span> <span class="number">3</span> <span class="comment"># 最大启动时间，超时后变成失败</span></span><br><span class="line">  <span class="attr">concurrencyPolicy:</span> <span class="string">Forbid</span> <span class="comment"># Allow/Forbid/Replace，上个周期的Job未执行结束时，是否允许下个周期的Job开始执行，默认Allow</span></span><br><span class="line">  <span class="attr">suspend:</span> <span class="literal">false</span> <span class="comment"># 是否暂停cronjob的执行，一般通过kubectl edit修改</span></span><br><span class="line">  <span class="attr">successfulJobsHistoryLimit:</span> <span class="number">3</span> <span class="comment"># 保留多少条执行成功的Job记录，默认3</span></span><br><span class="line">  <span class="attr">failedJobsHistoryLimit:</span> <span class="number">1</span> <span class="comment"># 保留多少条执行失败的Job记录，默认1</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">command:</span> [ <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo &quot;Start Job!&quot;; sleep 30; echo &quot;Job Done!&quot;&#x27;</span> ]</span><br><span class="line">              <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">pods-cronjob-container</span></span><br></pre></td></tr></table></figure><p>如上这个任务会每分钟执行一次，详情如下</p><pre><code>~ kc apply -f job.yaml
cronjob.batch/pods-cronjob created
~ kc get cronjob
NAME           SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
pods-cronjob   */1 * * * *   False     0        &lt;none&gt;          8s
~ kc get pods
NAME                          READY   STATUS              RESTARTS   AGE
pods-cronjob-28410113-fs4hr   0/1     ContainerCreating   0          0s
~ kc get job 
NAME                    COMPLETIONS   DURATION   AGE
pods-cronjob-28410113   0/1           6s         6s
~ kc logs pods-cronjob-28410113-fs4hr
Start Job!
Job Done!
~ kc delete cronjob pods-cronjob       
cronjob.batch &quot;pods-cronjob&quot; deleted
</code></pre></div><div class="post-copyright"><div><strong>本文链接：</strong> <span title="Kubernetes的安装和使用（二）">https://www.nosuchfield.com/2022/10/30/Kubernetes-installation-and-use-2/</span></div><div><strong>版权声明： </strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处！</div></div><style>summary{cursor:pointer;margin-bottom:10px}summary:focus{outline:0}</style><script src="/js/code-enhancer.js"></script><script src="/js/pangu.min.js"></script><script>pangu.spacingPage()</script><script>function backToTop(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script defer src="https://cloud.umami.is/script.js" data-website-id="267e4aaf-8cb5-464d-b16c-89e66283e505"></script><div class="post-footer"><ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" rel="tag">云原生</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag">运维</a></li></ul><span onclick="backToTop()" class="top">返回顶部</span></div></article><footer><span>&copy; 2015 - 2025</span> <span class="author">Raymond</span> <span style="float:right"><span class="upyun">本网站由<a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"> <img src="/images/others/upyun.png"></a>提供CDN加速&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <a class="filing" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备15057335号</a> <a class="github" href="https://github.com/RitterHou" target="_blank">GitHub</a></span></footer></div></body></html>