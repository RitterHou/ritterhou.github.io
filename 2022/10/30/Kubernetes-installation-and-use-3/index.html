<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><title>Kubernetes的安装和使用（三） - 侯锐的思考与分享</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="keywords" content="运维,k8s,云原生"><meta name="description" content="&lt;h3 id=&#34;目录&#34;&gt;&lt;a href=&#34;#目录&#34; class=&#34;headerlink&#34; title=&#34;目录&#34;&gt;&lt;/a&gt;目录&lt;/h3&gt;&lt;p&gt;&lt;a href=&#34;/2022/10/30/Kubernetes-installation-and-use-1/&#34;&gt;Kubernetes的安装和使用（一）&lt;/a&gt;&lt;br&gt;&lt;a href=&#34;/2022/10/30/Kubernetes-installation-and-use-2/&#34;&gt;Kubernetes的安装和使用（二）&lt;/a&gt;&lt;br&gt;&lt;a href=&#34;/2022/10/30/Kubernetes-installation-and-use-3/&#34;&gt;Kubernetes的安装和使用（三）&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;k8s使用Service&#34;&gt;&lt;a href=&#34;#k8s使用Service&#34; class=&#34;headerlink&#34; title=&#34;k8s使用Service&#34;&gt;&lt;/a&gt;k8s使用Service&lt;/h2&gt;&lt;p&gt;在前面的例子中我们使用port-forward进行端口转发，这样会存在两个问题：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;pod重启后ip地址发生了"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="侯锐的思考与分享" type="application/atom+xml"></head><body><div class="container"><header class="header"><div class="blog-title"><a href="/" class="logo">侯锐的思考与分享</a><div class="subtitle"></div></div><nav class="navbar"><ul class="menu"><li class="menu-item"><a href="/" class="menu-item-link" data-no-instant>主页</a></li><li class="menu-item"><a href="/atom.xml" class="menu-item-link" data-no-instant>订阅</a></li><li class="menu-item"><a href="/search" class="menu-item-link" data-no-instant>搜索</a></li></ul></nav></header><article class="post"><div class="post-title"><h1 class="article-title">Kubernetes的安装和使用（三）</h1></div><div class="post-meta"><span class="post-time">2022-10-30</span></div><div class="post-content"><h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><p><a href="/2022/10/30/Kubernetes-installation-and-use-1/">Kubernetes的安装和使用（一）</a><br><a href="/2022/10/30/Kubernetes-installation-and-use-2/">Kubernetes的安装和使用（二）</a><br><a href="/2022/10/30/Kubernetes-installation-and-use-3/">Kubernetes的安装和使用（三）</a></p><h2 id="k8s使用Service"><a href="#k8s使用Service" class="headerlink" title="k8s使用Service"></a>k8s使用Service</h2><p>在前面的例子中我们使用port-forward进行端口转发，这样会存在两个问题：</p><ol><li>pod重启后ip地址发生了变化怎么办</li><li>如何进行负载均衡</li></ol><p>k8s的Service就是用来解决这个问题的，它包含ClusterIP、NodePort和Headless等模块。</p><h3 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h3><p>ClusterIP就是将多个pod用一个ip进行访问的服务，这个ip只能在集群内访问，我们创建如下的程序</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		host, _ := os.Hostname()</span><br><span class="line">		io.WriteString(w, fmt.Sprintf(<span class="string">&quot;[v3] Hello, Kubernetes!, From host: %s\n&quot;</span>, host))</span><br><span class="line">	&#125;)</span><br><span class="line">	http.ListenAndServe(<span class="string">&quot;:3000&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们将如上程序打包成镜像</p><pre><code>docker build . -t derobukal/hellok8s:v3_hostname
docker push derobukal/hellok8s:v3_hostname
</code></pre><p>然后启动k8s的deployment，可以得到3个运行的pod</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># deployment 唯一名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-go-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 副本数量</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span> <span class="comment"># 管理template下所有 app=hellok8s的pod，（要求和template.metadata.labels完全一致！！！否则无法部署deployment）</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># template 定义一组容器</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">derobukal/hellok8s:v3_hostname</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s</span></span><br></pre></td></tr></table></figure><p>之后我们创建service-clusterip.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-hellok8s-clusterip</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span>  <span class="comment"># 这行是默认的，可省略</span></span><br><span class="line"><span class="comment">#  sessionAffinity: ClientIP # or None, 设置会话亲和性（ClientIP表示同一客户端ip的请求会路由到同个Pod）</span></span><br><span class="line"><span class="comment">#  sessionAffinityConfig:</span></span><br><span class="line"><span class="comment">#    clientIP:</span></span><br><span class="line"><span class="comment">#      timeoutSeconds: 3600 # 范围 0~86400，默认10800（3h）</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">hellok8s</span>  <span class="comment"># 通过selector关联pod组</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span> <span class="comment"># service端口</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">3000</span> <span class="comment"># 后端pod端口</span></span><br></pre></td></tr></table></figure><p>随后启动service，并查看service所生成的clusterIp的值，以及clusterIp后面的endpoints的详细信息</p><pre><code>~ kc apply -f service-clusterip.yaml 
service/service-hellok8s-clusterip created
~ kc get svc                        
NAME                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
kubernetes                   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    7d1h
service-hellok8s-clusterip   ClusterIP   10.111.240.227   &lt;none&gt;        3000/TCP   10s
~ kc get endpoints
NAME                         ENDPOINTS                                            AGE
kubernetes                   192.168.49.2:8443                                    7d1h
service-hellok8s-clusterip   10.244.0.67:3000,10.244.0.68:3000,10.244.0.69:3000   16s
</code></pre><p>有了service之后，我们就可以很方便的通过clusterIp的地址访问服务了。因为我们使用的是minikube，为了能正常访问clusterIp，我们先创建一个nginx的pod</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p>之后我们进入nginx的pod测试clusterIp</p><pre><code>~ kc apply -f pod_nginx.yaml        
pod/nginx created
~ kc get pods
NAME                                READY   STATUS    RESTARTS   AGE
hellok8s-go-http-6f5d68bc64-6xrdx   1/1     Running   0          23m
hellok8s-go-http-6f5d68bc64-b7wq2   1/1     Running   0          23m
hellok8s-go-http-6f5d68bc64-rk59k   1/1     Running   0          23m
nginx                               1/1     Running   0          98s
~ kc exec nginx -it -- bash                            
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-b7wq2
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-rk59k
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-rk59k
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-b7wq2
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-6xrdx
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-b7wq2
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-rk59k
root@nginx:/# 
</code></pre><p>上面通过curl测试service，可以看到每次访问的后端pod都是不一样的。接下来我们增加pod的数量，可以看到endpoint的数量也发生了变化，同时测试请求也打到了新的pod上面</p><pre><code>~ kc scale deployment/hellok8s-go-http --replicas=10
deployment.apps/hellok8s-go-http scaled
~ kc get endpoints                                                             
NAME                         ENDPOINTS                                                        AGE
kubernetes                   192.168.49.2:8443                                                7d1h
service-hellok8s-clusterip   10.244.0.67:3000,10.244.0.68:3000,10.244.0.69:3000 + 7 more...   22m
~ kc get pods     
NAME                                READY   STATUS    RESTARTS   AGE
hellok8s-go-http-6f5d68bc64-5lxvs   1/1     Running   0          27s
hellok8s-go-http-6f5d68bc64-6xrdx   1/1     Running   0          29m
hellok8s-go-http-6f5d68bc64-b7wq2   1/1     Running   0          29m
hellok8s-go-http-6f5d68bc64-cl56f   1/1     Running   0          27s
hellok8s-go-http-6f5d68bc64-gbn9v   1/1     Running   0          27s
hellok8s-go-http-6f5d68bc64-k7db4   1/1     Running   0          27s
hellok8s-go-http-6f5d68bc64-m4h5s   1/1     Running   0          27s
hellok8s-go-http-6f5d68bc64-rk59k   1/1     Running   0          29m
hellok8s-go-http-6f5d68bc64-whpht   1/1     Running   0          27s
hellok8s-go-http-6f5d68bc64-xnvk2   1/1     Running   0          27s
nginx                               1/1     Running   0          8m13s
~ kc exec nginx -it -- bash
root@nginx:/# curl 10.111.240.227:3000                                 
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-6xrdx
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-b7wq2
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-m4h5s
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-whpht
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-whpht
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-cl56f
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-xnvk2
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-cl56f
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-cl56f
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-m4h5s
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-rk59k
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-whpht
root@nginx:/# curl 10.111.240.227:3000
[v3] Hello, Kubernetes!, From host: hellok8s-go-http-6f5d68bc64-k7db4
root@nginx:/# 
</code></pre><h3 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h3><p>clusterIp只能在集群内部进行访问，NodePort在clusterIp的基础上，还支持了通过k8s集群的节点进行访问。有如下的配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-hellok8s-nodeport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span>  <span class="comment"># pod端口</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30000</span>  <span class="comment"># 节点固定端口。在NodePort类型中，k8s要求在 30000-32767 范围内，否则apply报错</span></span><br><span class="line">    <span class="comment"># 若需要暴露多个端口，则按下面形式</span></span><br><span class="line"><span class="comment">#    - name: http</span></span><br><span class="line"><span class="comment">#      protocol: TCP</span></span><br><span class="line"><span class="comment">#      port: 80</span></span><br><span class="line"><span class="comment">#      targetPort: 9376</span></span><br><span class="line"><span class="comment">#    - name: https</span></span><br><span class="line"><span class="comment">#      protocol: TCP</span></span><br><span class="line"><span class="comment">#      port: 443</span></span><br><span class="line"><span class="comment">#      targetPort: 9377</span></span><br></pre></td></tr></table></figure><p>之后启动nodeport的服务，就可以在集群的节点上访问服务了</p><pre><code>~ kc apply -f service-nodeport.yaml 
service/service-hellok8s-nodeport created
~ kc get svc                       
NAME                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
kubernetes                   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          7d1h
service-hellok8s-clusterip   ClusterIP   10.111.240.227   &lt;none&gt;        3000/TCP         28m
service-hellok8s-nodeport    NodePort    10.106.138.169   &lt;none&gt;        3000:30000/TCP   17s
</code></pre><p><em>因为使用minikube创建服务，而非创建了k8s的集群，因此暂时不太方便测试该功能。</em></p></div><div class="post-copyright"><div><strong>本文链接：</strong> <span title="Kubernetes的安装和使用（三）">https://www.nosuchfield.com/2022/10/30/Kubernetes-installation-and-use-3/</span></div><div><strong>版权声明： </strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处！</div></div><style>summary{cursor:pointer;margin-bottom:10px}summary:focus{outline:0}</style><script src="/js/code-enhancer.js"></script><script src="/js/pangu.min.js"></script><script>pangu.spacingPage()</script><script>function backToTop(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script defer src="https://cloud.umami.is/script.js" data-website-id="267e4aaf-8cb5-464d-b16c-89e66283e505"></script><div class="post-footer"><ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" rel="tag">云原生</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag">运维</a></li></ul><span onclick="backToTop()" class="top">返回顶部</span></div></article><footer><span>&copy; 2015 - 2025</span> <span class="author">Raymond</span> <span style="float:right"><span class="upyun">本网站由<a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"> <img src="/images/others/upyun.png"></a>提供CDN加速&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <a class="filing" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备15057335号</a> <a class="github" href="https://github.com/RitterHou" target="_blank">GitHub</a></span></footer></div></body></html>