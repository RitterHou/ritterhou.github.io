<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><title>轻量级任务队列RQ的简单使用 - 侯锐的思考与分享</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="keywords" content="Python,任务队列"><meta name="description" content="&lt;p&gt;&lt;a href=&#34;https://python-rq.org/&#34;&gt;RQ&lt;/a&gt; (Redis Queue)是一个轻量级的Python任务队列，这里记录一下它的简单使用。&lt;/p&gt;
&lt;p&gt;首先安装RQ（这里使用的Python版本是3.8.0）&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;pip install rq==1.10.1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;随后创建如下的文件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;.
├── __init__.py
├── jobs.py
└── run.py
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;其中&lt;code&gt;__init__.py&lt;/code&gt;中通过连接redis-server创建了两个queue：default和queue_1&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;spa"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="侯锐的思考与分享" type="application/atom+xml"></head><body><div class="container"><header class="header"><div class="blog-title"><a href="/" class="logo">侯锐的思考与分享</a><div class="subtitle"></div></div><nav class="navbar"><ul class="menu"><li class="menu-item"><a href="/" class="menu-item-link" data-no-instant>主页</a></li><li class="menu-item"><a href="/atom.xml" class="menu-item-link" data-no-instant>订阅</a></li><li class="menu-item"><a href="/search" class="menu-item-link" data-no-instant>搜索</a></li></ul></nav></header><article class="post"><div class="post-title"><h1 class="article-title">轻量级任务队列RQ的简单使用</h1></div><div class="post-meta"><span class="post-time">2022-05-19</span></div><div class="post-content"><p><a target="_blank" rel="noopener" href="https://python-rq.org/">RQ</a> (Redis Queue)是一个轻量级的Python任务队列，这里记录一下它的简单使用。</p><p>首先安装RQ（这里使用的Python版本是3.8.0）</p><pre><code>pip install rq==1.10.1
</code></pre><p>随后创建如下的文件</p><pre><code>.
├── __init__.py
├── jobs.py
└── run.py
</code></pre><p>其中<code>__init__.py</code>中通过连接redis-server创建了两个queue：default和queue_1</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line">redis_conn = Redis(<span class="string">&#x27;127.0.0.1&#x27;</span>, db=<span class="number">0</span>)</span><br><span class="line">rq_default_queue = Queue(<span class="string">&#x27;default&#x27;</span>, connection=redis_conn)</span><br><span class="line">rq_queue_1 = Queue(<span class="string">&#x27;queue_1&#x27;</span>, connection=redis_conn)</span><br></pre></td></tr></table></figure><p>之后我们在<code>jobs.py</code>中定义需要执行的任务</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line">redis_cli = Redis(<span class="string">&#x27;127.0.0.1&#x27;</span>, db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务执行成功的回调函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">report_success</span>(<span class="params">job, connection, result, *args, **kwargs</span>):</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计网页单词数量的任务</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">count_words_at_url</span>(<span class="params">url</span>):</span><br><span class="line">    resp = requests.get(url)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(resp.text.split())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取Redis的key的服务</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_redis_keys</span>():</span><br><span class="line">    <span class="keyword">return</span> redis_cli.keys()</span><br></pre></td></tr></table></figure><p>创建好了任务发送队列和任务本身之后，我们就可以启动worker了。我们让worker监听两个队列：default和queue_1</p><pre><code>rq worker queue_1 default --with-scheduler
</code></pre><p>随后我们就可以在<code>run.py</code>中发送任务给worker去执行了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Retry</span><br><span class="line"><span class="keyword">from</span> rq_demo <span class="keyword">import</span> rq_default_queue, rq_queue_1</span><br><span class="line"><span class="keyword">from</span> jobs <span class="keyword">import</span> count_words_at_url, get_redis_keys, report_success</span><br><span class="line"></span><br><span class="line">rq_default_queue.enqueue(count_words_at_url, <span class="string">&#x27;https://www.jd.com&#x27;</span>, on_success=report_success, retry=Retry(<span class="built_in">max</span>=<span class="number">3</span>, interval=[<span class="number">1</span>, <span class="number">3</span>, <span class="number">6</span>]))</span><br><span class="line"></span><br><span class="line">job1 = rq_default_queue.enqueue(count_words_at_url, <span class="string">&#x27;http://nvie.com&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(job1.result)</span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(job1.result)</span><br><span class="line"></span><br><span class="line">job2 = rq_queue_1.enqueue_in(timedelta(seconds=<span class="number">5</span>), get_redis_keys)</span><br><span class="line"><span class="built_in">print</span>(job2.result)</span><br><span class="line">time.sleep(<span class="number">6</span>)</span><br><span class="line"><span class="built_in">print</span>(job2.result)</span><br></pre></td></tr></table></figure><p>执行结果如下</p><pre><code>None
330
None
[b&#39;rq:workers:queue_1&#39;, b&#39;rq:worker:93618c280dbb445d92380fc26a33bc93&#39;, b&#39;rq:job:909c68e7-a517-469a-ad33-c7f350e4f1dd&#39;, b&#39;rq:scheduler-lock:default&#39;, b&#39;rq:failed:default&#39;, b&#39;rq:wip:queue_1&#39;, b&#39;rq:job:f098f9f7-82b2-4a4f-b482-6d4cffd9b09e&#39;, b&#39;rq:job:e006b2b5-69cf-4240-a0f2-202d31d71ad9&#39;, b&#39;rq:scheduler-lock:queue_1&#39;, b&#39;rq:finished:default&#39;, b&#39;rq:queues&#39;, b&#39;rq:job:aaaaf0e1-3673-4652-8109-20c46ebb89e0&#39;, b&#39;rq:job:75b3839e-b8bb-45d8-bfe0-64ce63a502ab&#39;, b&#39;rq:job:3c013ebb-7e68-4af2-9291-2abc7f8f0ba3&#39;, b&#39;rq:job:8a40b7af-6b10-46a7-9b20-c9af734c0e26&#39;, b&#39;rq:clean_registries:default&#39;, b&#39;rq:job:43db8266-c1d0-4256-b355-00135e6a67c6&#39;, b&#39;rq:clean_registries:queue_1&#39;, b&#39;rq:job:e0f68454-c599-45db-b572-a7364f911b4f&#39;, b&#39;rq:job:f9adc85e-400a-4e33-95cc-6f68c4d8a0d2&#39;, b&#39;rq:workers&#39;, b&#39;rq:workers:default&#39;]
</code></pre><p>worker的输出如下</p><pre><code>➜  rq_demo git:(master) ./rq.sh
17:28:32 Worker rq:worker:93618c280dbb445d92380fc26a33bc93: started, version 1.10.1
17:28:32 Subscribing to channel rq:pubsub:93618c280dbb445d92380fc26a33bc93
17:28:32 *** Listening on queue_1, default...
17:28:32 Trying to acquire locks for default, queue_1
17:28:32 Cleaning registries for queue: queue_1
17:28:32 Cleaning registries for queue: default
17:28:38 default: jobs.count_words_at_url(&#39;https://www.jd.com&#39;) (f098f9f7-82b2-4a4f-b482-6d4cffd9b09e)
3700
17:28:39 default: Job OK (f098f9f7-82b2-4a4f-b482-6d4cffd9b09e)
17:28:39 Result is kept for 500 seconds
17:28:39 default: jobs.count_words_at_url(&#39;http://nvie.com&#39;) (43db8266-c1d0-4256-b355-00135e6a67c6)
17:28:40 default: Job OK (43db8266-c1d0-4256-b355-00135e6a67c6)
17:28:40 Result is kept for 500 seconds
17:28:45 queue_1: jobs.get_redis_keys() (75b3839e-b8bb-45d8-bfe0-64ce63a502ab)
17:28:45 queue_1: Job OK (75b3839e-b8bb-45d8-bfe0-64ce63a502ab)
17:28:45 Result is kept for 500 seconds
</code></pre><p>可以看到任务已经被执行了。当然，我们也可以起多个worker来同时接受任务去执行，这样可以提高任务的执行效率。</p><p>本文涉及到的代码都放在了我的<a target="_blank" rel="noopener" href="https://github.com/RitterHou/rq_demo">GitHub</a>上面。</p></div><div class="post-copyright"><div><strong>本文链接：</strong> <span title="轻量级任务队列RQ的简单使用">https://www.nosuchfield.com/2022/05/19/Simple-use-of-the-lightweight-task-queue-RQ/</span></div><div><strong>版权声明： </strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处！</div></div><style>summary{cursor:pointer;margin-bottom:10px}summary:focus{outline:0}</style><script src="/js/code-enhancer.js"></script><script src="/js/pangu.min.js"></script><script>pangu.spacingPage()</script><script>function backToTop(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script defer src="https://cloud.umami.is/script.js" data-website-id="267e4aaf-8cb5-464d-b16c-89e66283e505"></script><div class="post-footer"><ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97/" rel="tag">任务队列</a></li></ul><span onclick="backToTop()" class="top">返回顶部</span></div></article><footer><span>&copy; 2015 - 2025</span> <span class="author">Raymond</span> <span style="float:right"><span class="upyun">本网站由<a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"> <img src="/images/others/upyun.png"></a>提供CDN加速&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> <a class="filing" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备15057335号</a> <a class="github" href="https://github.com/RitterHou" target="_blank">GitHub</a></span></footer></div></body></html>